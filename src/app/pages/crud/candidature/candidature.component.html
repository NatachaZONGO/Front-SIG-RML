<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
<p-progressBar *ngIf="loading()" mode="indeterminate" styleClass="mb-4"></p-progressBar>

<p-toolbar styleClass="mb-6">
  <ng-template pTemplate="start">
    <p-dropdown *canSee="['Administrateur','Recruteur']"
      [options]="offresOptions"
      [(ngModel)]="selectedOffreId"
      [showClear]="true"
      placeholder="Filtrer par offre"
      styleClass="mr-2 min-w-20"
      (onChange)="onOffreChange()">
    </p-dropdown>

    <p-button
      label="Exporter CSV"
      icon="pi pi-download"
      severity="help"
      class="mr-2"
      (onClick)="exportCSV()"
      [disabled]="loading() || candidatures().length === 0">
    </p-button>

    <p-button
      label="Exporter PDF"
      icon="pi pi-file-pdf"
      severity="warn"
      (onClick)="exportPDF()"
      [disabled]="loading() || candidatures().length === 0">
    </p-button>
  </ng-template>

  <ng-template pTemplate="end">
    <p-iconField>
      <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
      <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Rechercher..." />
    </p-iconField>
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="candidatures()"
  [rows]="10"
  [paginator]="true"
  [rowsPerPageOptions]="[10,20,30]"
  [rowHover]="true"
  [globalFilterFields]="['fullName','email','telephone','offreTitre','statut']"
  dataKey="id"
  currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} candidatures"
  [showCurrentPageReport]="true"
  [loading]="loading()"
  loadingIcon="pi pi-spinner">

  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="fullName">Candidat <p-sortIcon field="fullName"></p-sortIcon></th>
      <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
      <th pSortableColumn="telephone">Téléphone <p-sortIcon field="telephone"></p-sortIcon></th>
      <th pSortableColumn="offreTitre">Offre <p-sortIcon field="offreTitre"></p-sortIcon></th>
      <th pSortableColumn="created_at">Soumise le <p-sortIcon field="created_at"></p-sortIcon></th>
      <th pSortableColumn="statut">Statut <p-sortIcon field="statut"></p-sortIcon></th>
      <th style="min-width: 220px">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-c>
    <tr>
      <td><span class="font-semibold">{{ c.fullName || '—' }}</span></td>
      <td>
        <a *ngIf="c.email" [href]="'mailto:' + c.email" class="text-blue-500 hover:underline">{{ c.email }}</a>
        <span *ngIf="!c.email">—</span>
      </td>
      <td>{{ c.telephone || '—' }}</td>
      <td>{{ c.offreTitre || '—' }}</td>
      <td>{{ c.created_at || '—' }}</td>
      <td><p-tag [value]="c.statut || '—'" [severity]="getSeverity(c.statut)"></p-tag></td>
      <td>
        <div class="flex flex-wrap gap-1">
          <!-- Voir détails -->
          <p-button
            icon="pi pi-eye"
            [rounded]="true"
            [outlined]="true"
            size="small"
            severity="info"
            (onClick)="openDetail(c)"
            pTooltip="Voir détails">
          </p-button>

          <!-- Modifier le statut -->
          <p-button *canSee="['Administrateur']"
            icon="pi pi-pencil"
            [rounded]="true"
            [outlined]="true"
            size="small"
            severity="secondary"
            (onClick)="openModifyDialog(c)"
            pTooltip="Modifier le statut">
          </p-button>

          <!-- Supprimer -->
          <p-button *canSee="['Administrateur']"
            icon="pi pi-trash"
            [rounded]="true"
            [outlined]="true"
            size="small"
            severity="danger"
            (onClick)="deleteCandidature(c)"
            pTooltip="Supprimer la candidature">
          </p-button>

          <ng-container *canSee="['Administrateur','Recruteur']">
          <!-- Télécharger CV -->
          <p-button 
            *ngIf="c.cv_dl"
            icon="pi pi-download"
            [rounded]="true"
            [outlined]="true"
            size="small"
            severity="success"
            (onClick)="downloadCV(c)"
            pTooltip="Télécharger le CV">
          </p-button>

          <p-button *ngIf="c.lm_dl"
                    icon="pi pi-file"
                    [rounded]="true"
                    [outlined]="true"
                    size="small"
                    severity="help"
                    (onClick)="downloadLM(c)"
                    pTooltip="Télécharger la lettre (fichier)">
          </p-button>
        </ng-container>


          <!-- Export WP Form -->
          <p-button
            icon="pi pi-external-link"
            [rounded]="true"
            [outlined]="true"
            size="small"
            severity="warn"
            (onClick)="downloadWPForm(c)"
            pTooltip="Télécharger en format WP Form (HTML)">
          </p-button>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="7" class="text-center py-8">
        <div class="flex flex-col items-center gap-2">
          <i class="pi pi-users text-4xl text-gray-400"></i>
          <p class="text-gray-500">Aucune candidature trouvée</p>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- DIALOG DÉTAIL -->
<p-dialog 
  [(visible)]="detailDialog" 
  [style]="{width: '850px', maxWidth: '90vw'}" 
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="candidature-dialog">
  
  <!-- En-tête personnalisé -->
  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="bg-white/20 rounded-full p-2.5 mr-3">
              <i class="pi pi-file-edit text-2xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold">Détail de la candidature</h2>
              <p class="text-white/80 text-sm mt-0.5">{{ current?.offre?.titre || 'Offre' }}</p>
            </div>
          </div>
          <p-tag 
            [value]="current?.statut || '—'" 
            [severity]="getSeverity(current?.statut)"
            styleClass="text-sm font-semibold">
          </p-tag>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div *ngIf="current" class="space-y-5">
      
      <!-- Section: Informations du candidat -->
      <div class="bg-gray-50 rounded-xl p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-user text-blue-600 mr-2"></i>
          Informations du candidat
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Nom complet -->
          <div class="flex items-start space-x-3">
            <i class="pi pi-id-card text-gray-500 mt-0.5"></i>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 mb-0.5">Nom complet</p>
              <p class="font-semibold text-gray-800 truncate">{{ current.fullName || '—' }}</p>
            </div>
          </div>

          <!-- Email -->
          <div class="flex items-start space-x-3">
            <i class="pi pi-envelope text-gray-500 mt-0.5"></i>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 mb-0.5">Email</p>
              <a *ngIf="current.email" 
                 [href]="'mailto:' + current.email" 
                 class="text-blue-600 hover:underline font-medium truncate block">
                {{ current.email }}
              </a>
              <span *ngIf="!current.email" class="text-gray-400">Non renseigné</span>
            </div>
          </div>

          <!-- Téléphone -->
          <div class="flex items-start space-x-3">
            <i class="pi pi-phone text-gray-500 mt-0.5"></i>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 mb-0.5">Téléphone</p>
              <p class="font-semibold text-gray-800">{{ current.telephone || '—' }}</p>
            </div>
          </div>

          <!-- Date de candidature -->
          <div class="flex items-start space-x-3">
            <i class="pi pi-calendar text-gray-500 mt-0.5"></i>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 mb-0.5">Date de candidature</p>
              <p class="font-semibold text-gray-800">
                {{ current.created_at ? (current.created_at | date:'dd/MM/yyyy à HH:mm') : '—' }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Lettre de motivation -->
      <div class="bg-gray-50 rounded-xl p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-file-edit text-orange-600 mr-2"></i>
          Lettre de motivation
        </h3>

        <!-- Si fichier LM -->
        <ng-container *ngIf="current?.lm_dl; else lmTextBlock">
          <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200">
            <div class="flex items-center space-x-3 min-w-0">
              <i class="pi pi-file-pdf text-xl text-orange-600"></i>
              <div class="min-w-0">
                <p class="font-medium text-gray-800">Lettre de motivation (fichier)</p>
                <p class="text-xs text-gray-500">Document joint à la candidature</p>
              </div>
            </div>
            <a [href]="current.lm_dl"
               target="_blank"
               class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1.5 rounded-lg text-sm transition-colors flex items-center whitespace-nowrap ml-3">
              <i class="pi pi-download mr-1.5 text-sm"></i>
              Télécharger
            </a>
          </div>
        </ng-container>

        <!-- Texte de motivation -->
        <ng-template #lmTextBlock>
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <p class="text-gray-700 whitespace-pre-line leading-relaxed text-sm">
              {{ current?.motivationText || 'Aucune lettre de motivation fournie' }}
            </p>
          </div>
        </ng-template>
      </div>

      <!-- Section: Documents joints -->
      <div class="bg-gray-50 rounded-xl p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-paperclip text-green-600 mr-2"></i>
          Documents joints
        </h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          
          <!-- CV -->
          <div *ngIf="current?.cv_dl; else noCv" 
               class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
            <div class="flex items-center space-x-2 min-w-0">
              <i class="pi pi-file text-lg text-green-600"></i>
              <div class="min-w-0">
                <p class="font-medium text-gray-800 text-sm truncate">Curriculum Vitae</p>
                <p class="text-xs text-gray-500">CV du candidat</p>
              </div>
            </div>
            <a [href]="current.cv_dl"
               target="_blank"
               class="text-green-600 hover:text-green-700 ml-2">
              <i class="pi pi-download"></i>
            </a>
          </div>
          <ng-template #noCv>
            <div class="flex items-center p-3 bg-gray-100 rounded-lg border border-gray-200">
              <i class="pi pi-times-circle text-gray-400 mr-2 text-sm"></i>
              <span class="text-gray-500 text-sm">CV non fourni</span>
            </div>
          </ng-template>

          <!-- Lettre (fichier) -->
          <div *ngIf="current?.lm_dl; else noLmFile" 
               class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
            <div class="flex items-center space-x-2 min-w-0">
              <i class="pi pi-file-pdf text-lg text-green-600"></i>
              <div class="min-w-0">
                <p class="font-medium text-gray-800 text-sm truncate">Lettre de motivation</p>
                <p class="text-xs text-gray-500">Document PDF</p>
              </div>
            </div>
            <a [href]="current.lm_dl"
               target="_blank"
               class="text-green-600 hover:text-green-700 ml-2">
              <i class="pi pi-download"></i>
            </a>
          </div>
          <ng-template #noLmFile>
            <div class="flex items-center p-3 bg-gray-100 rounded-lg border border-gray-200">
              <i class="pi pi-info-circle text-gray-400 mr-2 text-sm"></i>
              <span class="text-gray-500 text-sm">Lettre en texte</span>
            </div>
          </ng-template>
        </div>
      </div>

    </div>
  </ng-template>

  <!-- Footer avec actions -->
  <ng-template pTemplate="footer">
    <div class="flex flex-col sm:flex-row justify-between gap-3">
      <!-- Actions de validation -->
      <div class="flex gap-2" *canSee="['Administrateur','Recruteur']">
        <button *ngIf="current?.statut === 'en_attente'"
                pButton
                label="Accepter"
                icon="pi pi-check"
                class="p-button-success p-button-sm"
                (click)="changerStatut(current, 'acceptee')">
        </button>
        <button *ngIf="current?.statut === 'en_attente'"
                pButton
                label="Refuser"
                icon="pi pi-times"
                class="p-button-danger p-button-sm"
                (click)="changerStatut(current, 'refusee')">
        </button>
      </div>

      <!-- Actions générales -->
      <div class="flex gap-2 sm:ml-auto">
        <button pButton
                label="Exporter (HTML)"
                icon="pi pi-file-export"
                class="p-button-outlined p-button-sm"
                (click)="downloadWPForm(current)">
        </button>
        <button pButton
                label="Fermer"
                icon="pi pi-times"
                class="p-button-secondary p-button-sm"
                (click)="detailDialog=false">
        </button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog pour modifier le statut -->
<p-dialog [(visible)]="modifyDialog" [style]="{width: '500px'}" header="Modifier le statut de la candidature" [modal]="true">
  <ng-template pTemplate="content">
    <div *ngIf="currentToModify">
      <p class="mb-3"><strong>Candidat :</strong> {{ currentToModify.fullName }}</p>
      <p class="mb-3"><strong>Offre :</strong> {{ currentToModify.offreTitre }}</p>

      <div class="field">
        <label for="nouveauStatut" class="block font-semibold mb-2">Nouveau statut</label>
        <p-dropdown
          id="nouveauStatut"
          [options]="statutOptions"
          [(ngModel)]="nouveauStatut"
          placeholder="Choisir un statut"
          class="w-full">
        </p-dropdown>
      </div>

      <div *ngIf="nouveauStatut === 'refusee'" class="field">
        <label for="motifRefus" class="block font-semibold mb-2">Motif du refus (optionnel)</label>
        <textarea
          id="motifRefus"
          pInputTextarea
          [(ngModel)]="motifRefus"
          rows="3"
          class="w-full"
          placeholder="Expliquez la raison du refus...">
        </textarea>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button
      label="Annuler"
      icon="pi pi-times"
      severity="secondary"
      [outlined]="true"
      (onClick)="modifyDialog = false">
    </p-button>
    <p-button
      label="Confirmer"
      icon="pi pi-check"
      severity="primary"
      (onClick)="confirmModifyStatut()"
      [disabled]="!nouveauStatut">
    </p-button>
  </ng-template>
</p-dialog>
<style>
.required::after { content: ' *'; color: red; }
/* Dialog principal */
::ng-deep .candidature-dialog .p-dialog {
  border-radius: 0.75rem !important;
  overflow: hidden;
  box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
}

/* Header */
::ng-deep .candidature-dialog .p-dialog-header {
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
}

/* Content avec padding cohérent */
::ng-deep .candidature-dialog .p-dialog-content {
  padding: 1.25rem !important;
  max-height: calc(80vh - 120px);
  overflow-y: auto;
  overflow-x: hidden; /* Empêche le débordement horizontal */
}

/* Footer */
::ng-deep .candidature-dialog .p-dialog-footer {
  padding: 1rem 1.25rem !important;
  background: #fafafa;
  border-top: 1px solid #e5e7eb;
}

/* Scrollbar personnalisée */
::ng-deep .candidature-dialog .p-dialog-content::-webkit-scrollbar {
  width: 6px;
}

::ng-deep .candidature-dialog .p-dialog-content::-webkit-scrollbar-track {
  background: #f3f4f6;
  border-radius: 3px;
}

::ng-deep .candidature-dialog .p-dialog-content::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

::ng-deep .candidature-dialog .p-dialog-content::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Tags */
::ng-deep .candidature-dialog .p-tag {
  padding: 0.25rem 0.75rem !important;
  border-radius: 9999px !important;
  font-size: 0.875rem !important;
}

/* Boutons */
::ng-deep .candidature-dialog .p-button-sm {
  padding: 0.5rem 1rem !important;
  font-size: 0.875rem !important;
}

/* Fix pour éviter les débordements de texte */
.truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.min-w-0 {
  min-width: 0;
}

/* Espacement uniforme */
.space-y-5 > * + * {
  margin-top: 1.25rem;
}
</style>