<p-toast></p-toast>
<p-confirmDialog 
  [style]="{ width: '420px' }" 
  header="Confirmer"
  icon="pi pi-exclamation-triangle"
  acceptLabel="Oui"
  rejectLabel="Non">
</p-confirmDialog>
<p-toolbar styleClass="mb-6">
  <ng-template pTemplate="start">
    <p-button label="Nouvelle entreprise" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    <p-button severity="secondary" label="Supprimer" icon="pi pi-trash" outlined
              (onClick)="deleteSelectedEntreprises()" [disabled]="!selectedEntreprises || !selectedEntreprises.length" />
  </ng-template>

  <ng-template pTemplate="end">
    <div class="flex gap-2">
      <p-button 
        label="Export CSV" 
        icon="pi pi-file-excel" 
        severity="secondary" 
        (onClick)="exportCSV()"
        [disabled]="entreprises().length === 0" />
      <p-button 
        label="Export PDF" 
        icon="pi pi-file-pdf" 
        severity="warn" 
        (onClick)="exportPDF()"
        [disabled]="entreprises().length === 0" />
    </div>
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="entreprises()"
  [rows]="rowsPerPage"
  [paginator]="true"
  [rowHover]="true"
  dataKey="id"
  [totalRecords]="totalRecords"
  [lazy]="true"
  (onLazyLoad)="onPageChange($event)"
  currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entreprises"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 15, 20, 30]"
  [globalFilterFields]="['nom_entreprise','user.email','user.nom','secteur_activite','statut']"
  [(selection)]="selectedEntreprises"
>
  <!-- CAPTION -->
  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <h5 class="m-0">Gestion des entreprises</h5>
      
      <div class="flex items-center gap-4">
        <!-- Filtre par statut -->
        <div class="flex items-center gap-2">
          <label for="statusFilter" class="text-sm font-medium">Filtrer par statut:</label>
          <p-dropdown 
            id="statusFilter"
            [(ngModel)]="selectedStatusFilter" 
            [options]="statusFilterOptions" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Tous les statuts"
            [style]="{ 'min-width': '150px' }"
            (onChange)="onStatusFilterChange($event)"
            [showClear]="true">
          </p-dropdown>
        </div>
        
        <!-- Recherche globale -->
        <p-iconField>
          <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
          <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Recherche..." />
        </p-iconField>
      </div>
    </div>
  </ng-template>

  <!-- HEADER -->
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th pSortableColumn="nom_entreprise" style="min-width:16rem">
        Nom entreprise <p-sortIcon field="nom_entreprise" />
      </th>
      <th style="min-width:12rem">Propriétaire</th>
      <th pSortableColumn="secteur_activite" style="min-width:12rem">
        Secteur <p-sortIcon field="secteur_activite" />
      </th>
      <th style="min-width:12rem">Contact</th>
      <th style="min-width:8rem">Logo</th>
      <th pSortableColumn="statut" style="min-width:10rem">
        Statut <p-sortIcon field="statut" />
      </th>
      <th style="min-width:8rem">Pays</th>
      <th style="min-width:16rem">Actions</th>
    </tr>
  </ng-template>

  <!-- BODY -->
  <ng-template pTemplate="body" let-entreprise>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="entreprise" />
      </td>
      <td>
        <div class="flex flex-col">
          <span class="font-semibold">{{ entreprise.nom_entreprise || 'N/A' }}</span>
          <small class="text-gray-500" *ngIf="entreprise.description">
            {{ entreprise.description.length > 50 ? (entreprise.description | slice:0:50) + '...' : entreprise.description }}
          </small>
        </div>
      </td>
      <td>
        <div class="flex flex-col" *ngIf="entreprise.user">
          <span class="font-medium">{{ entreprise.user.nom }} {{ entreprise.user.prenom }}</span>
          <small class="text-gray-500">{{ entreprise.user.email }}</small>
        </div>
        <span *ngIf="!entreprise.user" class="text-gray-400">N/A</span>
      </td>
      <td>
        <p-tag *ngIf="entreprise.secteur_activite" 
               [value]="entreprise.secteur_activite" 
               severity="info">
        </p-tag>
        <span *ngIf="!entreprise.secteur_activite" class="text-gray-400">N/A</span>
      </td>
      <td>
        <div class="flex flex-col">
          <span *ngIf="entreprise.email" class="text-sm">
            <i class="pi pi-envelope mr-1"></i>{{ entreprise.email }}
          </span>
          <span *ngIf="entreprise.telephone" class="text-sm">
            <i class="pi pi-phone mr-1"></i>{{ entreprise.telephone }}
          </span>
          <span *ngIf="entreprise.site_web" class="text-sm">
            <i class="pi pi-globe mr-1"></i>
            <a [href]="entreprise.site_web" target="_blank" class="text-blue-500 hover:underline">
              Site web
            </a>
          </span>
        </div>
      </td>
      <td>
        <!-- Logo dans le tableau -->
        <ng-container *ngIf="entreprise.logo; else noLogoTemplate">
          <img [src]="getImageUrl(entreprise.logo)"
               alt="Logo de {{ entreprise.nom_entreprise }}"
               [ngStyle]="{ width: '50px', height: '50px', 'object-fit': 'cover', 'border-radius': '6px' }"
               >
        </ng-container>
        <ng-template #noLogoTemplate>
          <div class="flex items-center justify-center w-12 h-12 bg-gray-200 rounded"
               style="width: 50px; height: 50px;">
            <i class="pi pi-building text-gray-400"></i>
          </div>
        </ng-template>
      </td>
      <td>
        <p-tag [value]="entreprise.statut" 
               [severity]="getStatusSeverity(entreprise.statut || '')">
        </p-tag>
        <div *ngIf="hasMotif(entreprise.motif_rejet)" class="mt-1">
            <small class="text-red-500">{{ entreprise.motif_rejet }}</small>
        </div>


      </td>
      <td>
        <span *ngIf="entreprise.pays">{{ entreprise.pays.nom }}</span>
        <span *ngIf="!entreprise.pays" class="text-gray-400">N/A</span>
      </td>
      <td>
        <div class="flex gap-2">
          <!-- Bouton détails -->
          <p-button icon="pi pi-eye" [rounded]="true" [outlined]="true" 
                    severity="info" size="small" (click)="openEntrepriseDetail(entreprise)"
                    pTooltip="Voir les détails" tooltipPosition="top" />
          <!-- Bouton modifier -->
          <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" 
                    severity="secondary" size="small" (click)="editEntreprise(entreprise)"
                    pTooltip="Modifier" tooltipPosition="top" />
          
          <!-- Actions spécifiques selon le statut -->
          <ng-container [ngSwitch]="entreprise.statut">
            <!-- Si en attente : boutons valider/rejeter -->
            <ng-container *ngSwitchCase="'en attente'">
              <p-button icon="pi pi-check" [rounded]="true" [outlined]="true" 
                        severity="success" size="small" 
                        (click)="openValidationDialog(entreprise)"
                        pTooltip="Valider l'entreprise" tooltipPosition="top" />
              <p-button icon="pi pi-times" [rounded]="true" [outlined]="true" 
                        severity="danger" size="small" 
                        (click)="openRejectionDialog(entreprise)"
                        pTooltip="Rejeter l'entreprise" tooltipPosition="top" />
            </ng-container>
            
            <!-- Si validé : indicateur -->
            <ng-container *ngSwitchCase="'valide'">
              <p-button icon="pi pi-shield" [rounded]="true" [outlined]="true" 
                        severity="success" size="small" [disabled]="true"
                        pTooltip="Entreprise validée" tooltipPosition="top" />
            </ng-container>

            
            <!-- Si refusé : bouton revalider -->
            <ng-container *ngSwitchCase="'refuse'">
              <p-button icon="pi pi-refresh" [rounded]="true" [outlined]="true" 
                        severity="warn" size="small" 
                        (click)="revaliderDepuisRefuse(entreprise)"
                        pTooltip="Revalider l'entreprise" tooltipPosition="top" />
            </ng-container>
          </ng-container>
          
          <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" 
                    size="small" (click)="deleteEntreprise(entreprise)"
                    pTooltip="Supprimer" tooltipPosition="top" />
        </div>

      </td>
    </tr>
</ng-template>
</p-table>

<p-dialog
  [(visible)]="detailEntrepriseDialog"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  styleClass="entreprise-detail-dialog"
  [style]="{ width: '920px', maxWidth: '95vw' }">

  <!-- Header custom -->
  <ng-template pTemplate="header">
    <div class="ed-header">
      <div class="ed-title">
        <div class="ed-logo-wrap">
          <ng-container *ngIf="currentEntreprise?.logo; else noLogoLarge">
            <img [src]="getImageUrl(currentEntreprise!.logo!)" alt="Logo"
                 class="ed-logo" />
          </ng-container>
          <ng-template #noLogoLarge>
            <div class="ed-logo ed-logo-fallback">
              <i class="pi pi-building"></i>
            </div>
          </ng-template>
        </div>
        <div>
          <h2 class="ed-name">{{ currentEntreprise?.nom_entreprise || 'Entreprise' }}</h2>
          <div class="ed-sub">
            <span *ngIf="currentEntreprise?.secteur_activite" class="mr-2">
              <i class="pi pi-briefcase mr-1"></i>{{ currentEntreprise?.secteur_activite }}
            </span>
            <span *ngIf="currentEntreprise?.pays?.nom">
              <i class="pi pi-globe mr-1"></i>{{ currentEntreprise?.pays?.nom }}
            </span>
          </div>
        </div>
      </div>
      <p-tag
        [value]="currentEntreprise?.statut || '—'"
        [severity]="getStatusSeverity(currentEntreprise?.statut || '')"
        styleClass="px-3 py-2">
      </p-tag>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div *ngIf="currentEntreprise" class="ed-content">

      <!-- Carte infos principales -->
      <div class="ed-card grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="ed-item">
          <div class="ed-item-icon"><i class="pi pi-user"></i></div>
          <div>
            <div class="ed-item-label">Propriétaire</div>
            <div class="ed-item-value">
              <ng-container *ngIf="currentEntreprise.user; else noOwner">
                {{ currentEntreprise.user.nom }} {{ currentEntreprise.user.prenom }}
                <div class="text-sm text-gray-500">{{ currentEntreprise.user.email }}</div>
              </ng-container>
              <ng-template #noOwner>—</ng-template>
            </div>
          </div>
        </div>

        <div class="ed-item">
          <div class="ed-item-icon"><i class="pi pi-envelope"></i></div>
          <div>
            <div class="ed-item-label">Email</div>
            <div class="ed-item-value">
              <a *ngIf="currentEntreprise.email"
                 [href]="'mailto:' + currentEntreprise.email"
                 class="text-blue-600 hover:underline">
                {{ currentEntreprise.email }}
              </a>
              <span *ngIf="!currentEntreprise.email">—</span>
            </div>
          </div>
        </div>

        <div class="ed-item">
          <div class="ed-item-icon"><i class="pi pi-phone"></i></div>
          <div>
            <div class="ed-item-label">Téléphone</div>
            <div class="ed-item-value">{{ currentEntreprise.telephone || '—' }}</div>
          </div>
        </div>

        <div class="ed-item">
          <div class="ed-item-icon"><i class="pi pi-globe"></i></div>
          <div>
            <div class="ed-item-label">Site web</div>
            <div class="ed-item-value">
              <a *ngIf="currentEntreprise.site_web"
                 [href]="currentEntreprise.site_web" target="_blank"
                 class="text-blue-600 hover:underline">
                {{ currentEntreprise.site_web }}
              </a>
              <span *ngIf="!currentEntreprise.site_web">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="ed-card">
        <div class="ed-section-title">
          <i class="pi pi-align-left mr-2"></i> Description
        </div>
        <div class="ed-desc">
          {{ currentEntreprise.description || 'Aucune description fournie.' }}
        </div>
      </div>

      <!-- Bandeau “motif de rejet” si présent -->
      <div *ngIf="hasMotif(currentEntreprise.motif_rejet)" class="ed-banner-error">
        <i class="pi pi-exclamation-triangle mr-2"></i>
        {{ currentEntreprise.motif_rejet }}
      </div>

    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between w-full items-center">
      <div class="text-sm text-gray-500">
        ID: {{ currentEntreprise?.id }} • Statut: {{ currentEntreprise?.statut || '—' }}
      </div>
      <div class="flex gap-2">
        <p-button
          label="Modifier"
          icon="pi pi-pencil"
          severity="info"
          (onClick)="editEntreprise(currentEntreprise!)">
        </p-button>
        <p-button
          label="Fermer"
          icon="pi pi-times"
          class="p-button-secondary"
          (onClick)="detailEntrepriseDialog=false">
        </p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>
<style>
  /* Dialog header */
::ng-deep .entreprise-detail-dialog .p-dialog-header {
  padding: 0 !important;
  border: 0 !important;
}
.ed-header {
  display:flex; align-items:center; justify-content:space-between;
  padding: 18px 24px;
  background: linear-gradient(90deg, #2563eb, #3b82f6);
  color: #fff;
}
.ed-title { display:flex; gap:14px; align-items:center; }
.ed-logo-wrap { width:56px; height:56px; }
.ed-logo {
  width:56px; height:56px; object-fit:cover; border-radius:10px;
  background:#fff;
}
.ed-logo-fallback {
  display:flex; align-items:center; justify-content:center;
  font-size:22px; color:#94a3b8; background:#fff;
}
.ed-name { margin:0; font-size:20px; font-weight:700; }
.ed-sub { opacity:.9; font-size:12px; margin-top:2px; }

/* Content */
::ng-deep .entreprise-detail-dialog .p-dialog-content { padding: 16px 24px 8px; }
.ed-content { display:flex; flex-direction:column; gap:16px; }
.ed-card {
  background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;
}
.ed-item { display:flex; gap:12px; align-items:flex-start; }
.ed-item-icon {
  width:36px; height:36px; border-radius:9999px;
  display:flex; align-items:center; justify-content:center;
  background:#eff6ff; color:#2563eb;
}
.ed-item-label { font-size:12px; color:#6b7280; }
.ed-item-value { font-weight:600; color:#111827; }
.ed-section-title { font-weight:700; color:#111827; margin-bottom:8px; }
.ed-desc { color:#374151; line-height:1.6; white-space:pre-wrap; }
.ed-banner-error {
  background:#fef2f2; color:#b91c1c; border:1px solid #fecaca;
  border-radius:10px; padding:10px 12px; display:flex; align-items:center;
}

</style>