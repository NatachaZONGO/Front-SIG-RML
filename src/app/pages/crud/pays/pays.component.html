<p-toast />
<p-confirmDialog />

<!-- Toolbar avec boutons colorés -->
<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button 
            label="Nouveau pays" 
            icon="pi pi-plus" 
            severity="success"
            class="mr-2" 
            (onClick)="ouvrirNouveau()" />
        <p-button 
            severity="danger" 
            label="Supprimer" 
            icon="pi pi-trash" 
            [outlined]="true"
            (onClick)="supprimerPaysSelectionnes()" 
            [disabled]="!paysSelectionnes || !paysSelectionnes.length" />
    </ng-template>

    <ng-template #end>
        <p-button 
            label="Exporter CSV" 
            icon="pi pi-download" 
            severity="help"
            (click)="exporterCSV()" />
    </ng-template>
</p-toolbar>

<p-table
    #dt
    [value]="listePays"
    [rows]="10"
    [paginator]="true"
    [globalFilterFields]="['nom', 'code', 'isActive']"
    [tableStyle]="{ 'min-width': '75rem' }"
    [(selection)]="paysSelectionnes"
    [rowHover]="true"
    dataKey="id"
    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} pays"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 20, 30]">
    
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <h5 class="m-0 text-xl font-semibold">Gestion des Pays</h5>
            <p-iconField>
                <p-inputIcon styleClass="pi pi-search" />
                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher un pays..." />
            </p-iconField>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="width: 3rem">
                <p-tableHeaderCheckbox />
            </th>
            <th pSortableColumn="nom" style="min-width:12rem">
                Nom <p-sortIcon field="nom" />
            </th>
            <th pSortableColumn="code" style="min-width:8rem">
                Code ISO <p-sortIcon field="code" />
            </th>
            <th style="min-width:10rem">Drapeau</th>
            <th pSortableColumn="isActive" style="min-width:10rem">
                Statut <p-sortIcon field="isActive" />
            </th>
            <th style="min-width:10rem">Actions</th>
        </tr>
    </ng-template>

    <ng-template #body let-pays>
        <tr>
            <td>
                <p-tableCheckbox [value]="pays" />
            </td>
            <td >
                <span class="font-semibold">{{ pays.nom }}</span>
            </td>
            <td>
                <span class="font-mono font-semibold text-blue-600">{{ pays.code | uppercase }}</span>
            </td>
            <td>
                <div>
                    <img *ngIf="pays.flagImage" 
                         [src]="pays.flagImage" 
                         [alt]="'Drapeau de ' + pays.nom" 
                         class="flag-thumbnail" />
                    <div *ngIf="!pays.flagImage" class="flag-placeholder">
                        <i class="pi pi-image"></i>
                    </div>
                </div>
            </td>
            <td>
                <p-tag [severity]="pays.isActive ? 'success' : 'danger'" 
                       [value]="pays.isActive ? 'Actif' : 'Inactif'">
                </p-tag>
            </td>
            <td>
                <div class="flex gap-2">
                    <p-button 
                        icon="pi pi-pencil" 
                        [rounded]="true" 
                        [outlined]="true"
                        severity="secondary"
                        size="small"
                        (click)="modifierPays(pays)"
                        pTooltip="Modifier"
                        tooltipPosition="top">
                    </p-button>
                    <p-button 
                        icon="pi pi-trash" 
                        severity="danger" 
                        [rounded]="true" 
                        [outlined]="true"
                        size="small"
                        (click)="supprimerPays(pays)"
                        pTooltip="Supprimer"
                        tooltipPosition="top">
                    </p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="6" class="text-center py-8">
                <div class="flex flex-col items-center gap-2">
                    <i class="pi pi-globe text-4xl text-gray-400"></i>
                    <p class="text-gray-500">Aucun pays trouvé</p>
                    <p-button 
                        label="Ajouter le premier pays" 
                        icon="pi pi-plus" 
                        (onClick)="ouvrirNouveau()" 
                        size="small">
                    </p-button>
                </div>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Dialog Créer/Modifier Pays -->
<p-dialog 
    [(visible)]="paysDialog" 
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [closable]="true"
    styleClass="pays-dialog"
    [style]="{ width: '700px', maxWidth: '90vw' }">
    
    <!-- Header personnalisé -->
    <ng-template #header>
        <div class="dialog-custom-header">
            <div class="header-content">
                <div class="dialog-header-icon">
                    <i class="pi pi-globe"></i>
                </div>
                <div class="dialog-header-text">
                    <h2 class="text-xl font-bold m-0">
                        {{ currentPays.id ? 'Modifier le pays' : 'Nouveau pays' }}
                    </h2>
                    <p class="text-sm m-0 mt-1 opacity-90">
                        {{ currentPays.id ? 'Modifiez les informations du pays' : 'Ajoutez un nouveau pays à la liste' }}
                    </p>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #content>
        <div class="form-container">
            
            <!-- Section Informations générales -->
            <div class="form-section">
                <div class="section-header">
                    <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                    <h3 class="section-title">Informations générales</h3>
                </div>
                
                <div class="form-grid">
                    <!-- Nom du pays -->
                    <div class="form-field full-width">
                        <label for="nom" class="field-label">
                            Nom du pays <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <i class="pi pi-map-marker input-icon"></i>
                            <input 
                                type="text" 
                                pInputText 
                                id="nom" 
                                [(ngModel)]="currentPays.nom" 
                                placeholder="Ex: Burkina Faso"
                                [class.input-error]="submitted && !currentPays.nom"
                                class="field-input pl-10"
                                autofocus />
                        </div>
                        <small class="error-message" *ngIf="submitted && !currentPays.nom">
                            Le nom du pays est obligatoire
                        </small>
                    </div>

                    <!-- Code ISO -->
                    <div class="form-field">
                        <label for="code" class="field-label">
                            Code ISO <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <i class="pi pi-id-card input-icon"></i>
                            <input 
                                type="text" 
                                pInputText 
                                id="code" 
                                [(ngModel)]="currentPays.code" 
                                [maxlength]="2"
                                placeholder="Ex: BF"
                                [class.input-error]="submitted && !currentPays.code"
                                class="field-input pl-10"
                                (input)="currentPays.code = currentPays.code ? currentPays.code.toUpperCase() : ''" />
                        </div>
                        <small class="error-message" *ngIf="submitted && !currentPays.code">
                            Le code ISO est obligatoire (2 lettres)
                        </small>
                        <small class="text-gray-500 text-xs mt-1">
                            Code à 2 lettres (ex: FR, US, BF)
                        </small>
                    </div>

                    <!-- Statut -->
                    <div class="form-field">
                        <label class="field-label">Statut</label>
                        <div class="status-toggle">
                            <p-checkbox 
                                [(ngModel)]="currentPays.isActive" 
                                inputId="isActive" 
                                [binary]="true">
                            </p-checkbox>
                            <label for="isActive" class="toggle-label">
                                Pays actif (visible dans les listes)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Drapeau -->
            <div class="form-section">
                <div class="section-header">
                    <i class="pi pi-image text-blue-600 mr-2"></i>
                    <h3 class="section-title">Drapeau du pays</h3>
                </div>

                <!-- Choix du mode -->
                <div class="flag-mode-selector">
                    <label class="field-label mb-3">Source du drapeau</label>
                    <div class="mode-buttons">
                        <button 
                            type="button"
                            class="mode-btn"
                            [class.active]="flagSource === 'url'"
                            (click)="flagSource = 'url'">
                            <i class="pi pi-link"></i>
                            <span>URL externe</span>
                        </button>
                        <button 
                            type="button"
                            class="mode-btn"
                            [class.active]="flagSource === 'upload'"
                            (click)="flagSource = 'upload'">
                            <i class="pi pi-cloud-upload"></i>
                            <span>Upload fichier</span>
                        </button>
                    </div>
                </div>

                <!-- URL du drapeau -->
                <div class="form-field full-width mt-4" *ngIf="flagSource === 'url'">
                    <label for="flagUrl" class="field-label">URL du drapeau</label>
                    <div class="input-with-icon">
                        <i class="pi pi-link input-icon"></i>
                        <input 
                            type="text" 
                            pInputText 
                            id="flagUrl" 
                            [(ngModel)]="currentPays.flagImage" 
                            placeholder="https://example.com/drapeau.png"
                            class="field-input pl-10" />
                    </div>
                </div>

                <!-- Upload du drapeau -->
                <div class="form-field full-width mt-4" *ngIf="flagSource === 'upload'">
                    <label class="field-label">Télécharger le drapeau</label>
                    <div class="upload-zone">
                        <p-fileUpload 
                            mode="basic"
                            name="flagFile" 
                            accept="image/*" 
                            maxFileSize="1000000"
                            (onSelect)="onFileUpload($event)"
                            chooseLabel="Choisir une image"
                            [auto]="true"
                            [showCancelButton]="false"
                            [chooseIcon]="'pi pi-cloud-upload'"
                            class="custom-upload">
                        </p-fileUpload>
                        <small class="text-gray-500 text-xs mt-2">
                            PNG, JPG ou SVG (max. 1MB)
                        </small>
                    </div>
                </div>

                <!-- Aperçu du drapeau -->
                <div class="form-field full-width mt-4" *ngIf="currentPays.flagImage">
                    <label class="field-label">Aperçu du drapeau</label>
                    <div class="flag-preview-container">
                        <img 
                            [src]="currentPays.flagImage" 
                            [alt]="'Drapeau de ' + currentPays.nom" 
                            class="flag-preview-img">
                        <button 
                            type="button"
                            class="remove-flag-btn"
                            (click)="currentPays.flagImage = ''"
                            title="Supprimer">
                            <i class="pi pi-times"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </ng-template>

    <ng-template #footer>
        <div class="dialog-footer-custom">
            <p-button 
                label="Annuler" 
                icon="pi pi-times" 
                severity="secondary"
                [outlined]="true"
                styleClass="footer-btn-cancel"
                (click)="fermerDialog()">
            </p-button>
            <p-button 
                [label]="currentPays.id ? 'Mettre à jour' : 'Créer le pays'"
                [icon]="currentPays.id ? 'pi pi-check' : 'pi pi-plus'"
                styleClass="footer-btn-submit"
                (click)="sauvegarderPays()">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<style>
/* ============================================
   STYLES DU TABLEAU
   ============================================ */

.font-mono {
  font-family: 'Courier New', monospace;
}



.flag-thumbnail {
  width: 50px;
  height: 35px;
  object-fit: cover;
  border-radius: 4px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.flag-placeholder {
  width: 50px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f3f4f6;
  border-radius: 4px;
  border: 1px dashed #d1d5db;
  color: #9ca3af;
}

/* ============================================
   STYLES DU DIALOG PAYS
   ============================================ */

::ng-deep .pays-dialog .p-dialog {
  border-radius: 12px;
  overflow: hidden;
}

::ng-deep .pays-dialog .p-dialog-header {
  padding: 0 !important;
  border: 0 !important;
  background: transparent !important;
}

::ng-deep .pays-dialog .p-dialog-content {
  padding: 0 !important;
  max-height: 70vh;
  overflow-y: auto;
}

/* Header avec dégradé bleu - FULL WIDTH */
.dialog-custom-header {
  width: 100%;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.5rem 2rem;
}

.dialog-header-icon {
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  flex-shrink: 0;
}

.dialog-header-icon i {
  font-size: 1.75rem;
}

.dialog-header-text {
  flex: 1;
}

/* Container du formulaire */
.form-container {
  padding: 1.5rem 2rem;
  background: #f9fafb;
}

/* Section */
.form-section {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
}

.form-section:last-child {
  margin-bottom: 0;
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 12px;
  border-bottom: 2px solid #f3f4f6;
}

.section-title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #111827;
}

/* Grid de formulaire */
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.25rem;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field.full-width {
  grid-column: 1 / -1;
}

/* Labels */
.field-label {
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

.required {
  color: #ef4444;
}

/* Inputs */
.field-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
}

.field-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.input-error {
  border-color: #ef4444 !important;
}

.error-message {
  color: #ef4444;
  font-size: 13px;
  margin-top: 4px;
}

/* Input avec icône */
.input-with-icon {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 14px;
  z-index: 1;
}

.pl-10 {
  padding-left: 40px !important;
}

/* Toggle statut */
.status-toggle {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.toggle-label {
  font-weight: 500;
  color: #1f2937;
  cursor: pointer;
  user-select: none;
}

/* Sélecteur de mode drapeau */
.flag-mode-selector {
  margin-bottom: 1rem;
}

.mode-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.mode-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  color: #6b7280;
}

.mode-btn:hover {
  border-color: #3b82f6;
  background: #eff6ff;
}

.mode-btn.active {
  border-color: #3b82f6;
  background: #dbeafe;
  color: #1e40af;
}

.mode-btn i {
  font-size: 1.5rem;
}

/* Zone d'upload */
.upload-zone {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

::ng-deep .custom-upload .p-button {
  width: 100%;
  justify-content: center;
}

/* Aperçu du drapeau */
.flag-preview-container {
  position: relative;
  display: inline-block;
  padding: 1rem;
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
}

.flag-preview-img {
  max-width: 200px;
  max-height: 140px;
  object-fit: contain;
  border-radius: 8px;
  display: block;
}

.remove-flag-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  border: none;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.remove-flag-btn:hover {
  background: #dc2626;
  transform: scale(1.1);
}

/* Footer */
.dialog-footer-custom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  gap: 12px;
  padding: 1rem 2rem;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

::ng-deep .footer-btn-submit {
  background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
  border: none !important;
  padding: 10px 24px !important;
  font-weight: 600 !important;
}

::ng-deep .footer-btn-submit:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
}

::ng-deep .footer-btn-cancel {
  padding: 10px 24px !important;
}

/* Personnalisation PrimeNG */
::ng-deep .pays-dialog .p-inputtext {
  border: 1px solid #d1d5db;
  border-radius: 8px;
}

::ng-deep .pays-dialog .p-inputtext:enabled:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .mode-buttons {
    grid-template-columns: 1fr;
  }
  
  .form-section {
    padding: 1rem;
  }
  
  .header-content {
    padding: 1.25rem 1.5rem;
  }
  
  .dialog-footer-custom {
    flex-direction: column;
  }
  
  .form-container {
    padding: 1rem 1.25rem;
  }
}

/* Utilitaires */
.text-gray-400 {
  color: #9ca3af;
}

.text-gray-500 {
  color: #6b7280;
}

.text-gray-600 {
  color: #4b5563;
}

.text-blue-600 {
  color: #2563eb;
}
</style>