<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-toolbar styleClass="mb-6">
  <ng-template pTemplate="start">
    <p-button
      label="Nouvelle Publicité"
      icon="pi pi-plus"
      severity="secondary"
      class="mr-2"
      (onClick)="openNew()">
    </p-button>
    <p-button
      severity="secondary"
      label="Supprimer"
      icon="pi pi-trash"
      outlined
      (onClick)="deleteSelectedPublicites()"
      [disabled]="!selectedPublicites || !selectedPublicites.length">
    </p-button>
  </ng-template>

  <ng-template pTemplate="end">
    <div class="flex items-center gap-2">
      <p-iconField>
        <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
        <input
          pInputText
          type="text"
          (input)="onGlobalFilter(dt, $event)"
          placeholder="Rechercher..."
          class="w-full" />
      </p-iconField>
      <p-button
        label="Export CSV"
        icon="pi pi-download"
        severity="secondary"
        (onClick)="exportCSV()">
      </p-button>
    </div>
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="publicites"
  [rows]="10"
  [paginator]="true"
  [(selection)]="selectedPublicites"
  [rowHover]="true"
  dataKey="id"
  [globalFilterFields]="['titre','entreprise.nom_entreprise','lien_externe','statut']"
  [tableStyle]="{ 'min-width': '100rem' }"
  currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} publicités"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]">

  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between">
      <h2 class="m-0 text-xl font-semibold">Gestion des Publicités</h2>
      <div class="text-sm text-color-secondary">
        Sélectionnées : {{ selectedPublicites.length || 0 }}
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="header">
    <tr>
      <th style="width:3rem"><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
      <th pSortableColumn="titre" style="min-width:200px">
        Titre <p-sortIcon field="titre"></p-sortIcon>
      </th>
      <th pSortableColumn="entreprise.nom_entreprise" style="min-width:180px">
        Entreprise <p-sortIcon field="entreprise.nom_entreprise"></p-sortIcon>
      </th>
      <th style="min-width:200px">Média</th>
      <th pSortableColumn="lien_externe" style="min-width:220px">
        Lien <p-sortIcon field="lien_externe"></p-sortIcon>
      </th>
      <th pSortableColumn="statut" style="min-width:140px">
        Statut <p-sortIcon field="statut"></p-sortIcon>
      </th>
      <th style="min-width:220px">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-publicite>
    <tr>
      <td style="width:3rem"><p-tableCheckbox [value]="publicite"></p-tableCheckbox></td>

      <td style="min-width:200px">
        <div class="flex flex-col">
          <span class="font-semibold truncate" [title]="publicite.titre">{{ publicite.titre || '—' }}</span>
          <small class="text-gray-500">{{ (publicite.media_request || 'image') | titlecase }}</small>
        </div>
      </td>

      <td style="min-width:180px">
        {{ publicite.entreprise?.nom_entreprise || '—' }}
      </td>

      <td style="min-width:200px">
        <div class="flex items-center gap-3">
          <img *ngIf="publicite.image || publicite.image_url"
               [src]="publicite.image || publicite.image_url"
               alt="Image"
               class="pub-media-thumb">
          <video *ngIf="publicite.video || publicite.video_url"
                 [src]="publicite.video || publicite.video_url"
                 class="pub-media-thumb"
                 controls></video>
          <span *ngIf="!(publicite.image||publicite.image_url||publicite.video||publicite.video_url)"
                class="text-gray-400">—</span>
        </div>
      </td>

      <td style="min-width:220px">
        <ng-container *ngIf="publicite.lien_externe; else noLink">
          <a [href]="publicite.lien_externe" target="_blank" class="text-primary break-all">
            {{ publicite.lien_externe }} <i class="pi pi-external-link ml-1"></i>
          </a>
        </ng-container>
        <ng-template #noLink>—</ng-template>
      </td>

      <td style="min-width:140px">
        <p-tag [value]="publicite.statut || 'brouillon'"
               [severity]="getStatusColor(publicite.statut)"></p-tag>
      </td>

      <td style="min-width:220px">
        <div class="flex flex-wrap gap-1">
          <p-button
            *ngIf="canActivate(publicite)"
            icon="pi pi-play"
            [outlined]="true"
            size="small"
            severity="success"
            pTooltip="Activer"
            (onClick)="openActivationDialog(publicite)"></p-button>

          <p-button
            icon="pi pi-eye"
            [outlined]="true"
            [rounded]="true"
            size="small"
            severity="info"
            pTooltip="Détails"
            (onClick)="viewPubliciteDetails(publicite)"></p-button>

          <p-button
            icon="pi pi-pencil"
            [outlined]="true"
            [rounded]="true"
            size="small"
            severity="secondary"
            pTooltip="Modifier"
            (onClick)="editPublicite(publicite)"></p-button>

          <p-button
            icon="pi pi-trash"
            [outlined]="true"
            [rounded]="true"
            size="small"
            severity="danger"
            pTooltip="Supprimer"
            (onClick)="deletePublicite(publicite)"></p-button>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="7" class="text-center py-8">
        <div class="flex flex-col items-center gap-2">
          <i class="pi pi-image text-4xl text-gray-400"></i>
          <p class="text-gray-500">Aucune publicité trouvée</p>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- ============================= -->
<!-- DIALOG CRÉATION / ÉDITION     -->
<!-- ============================= -->
<p-dialog
  [(visible)]="publiciteDialog"
  [style]="{width: '850px', maxWidth: '95vw'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="offre-dialog-enhanced">

  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="bg-white/20 rounded-full p-3 mr-4">
              <i class="pi pi-bullhorn text-2xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold">
                {{ publicite.id ? 'Modifier la publicité' : 'Créer une publicité' }}
              </h2>
              <p class="text-white/80 text-sm mt-0.5">
                Média : {{ (publicite.media_request || 'image') | titlecase }}
              </p>
            </div>
          </div>
          <p-tag
            [value]="(publicite.statut || 'brouillon') | titlecase"
            [severity]="getStatusColor(publicite.statut)">
          </p-tag>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <form class="space-y-6">
      <div class="bg-blue-50/30 rounded-xl p-5 border border-blue-100">
        <div class="flex items-center mb-4">
          <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">1</div>
          <h3 class="text-lg font-semibold text-gray-800 ml-3">Informations de base</h3>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Titre <span class="text-red-500">*</span></label>
            <input pInputText type="text" class="w-full" [(ngModel)]="publicite.titre" name="titre" required>
            <small class="text-red-500 text-xs" *ngIf="submitted && !publicite.titre">
              <i class="pi pi-exclamation-circle mr-1"></i>Le titre est obligatoire
            </small>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Entreprise <span class="text-red-500">*</span></label>
            <p-dropdown
              [options]="entreprises"
              [(ngModel)]="publicite.entreprise_id"
              name="entreprise_id"
              optionLabel="nom_entreprise"
              optionValue="id"
              [filter]="true"
              [showClear]="true"
              placeholder="Sélectionner une entreprise"
              styleClass="w-full">
            </p-dropdown>
            <small class="text-red-500 text-xs" *ngIf="submitted && !publicite.entreprise_id">
              <i class="pi pi-exclamation-circle mr-1"></i>Requis
            </small>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Type de média <span class="text-red-500">*</span></label>

              <!-- PrimeNG ≥17 : p-select -->
              <p-select
                [options]="mediaModes"
                [(ngModel)]="publicite.media_request"
                name="media_request"
                placeholder="Choisir"
                class="w-full"
                (onChange)="onMediaModeChange()">
              </p-select>

              <!-- Si tu n'utilises PAS p-select, remplace par:
              <p-dropdown [options]="mediaModes" [(ngModel)]="publicite.media_request" name="media_request" placeholder="Choisir" styleClass="w-full" (onChange)="onMediaModeChange()"></p-dropdown>
              -->
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Lien externe</label>
              <input pInputText type="url" class="w-full break-all" [(ngModel)]="publicite.lien_externe" name="lien_externe" placeholder="https://votre-site.com">
            </div>
          </div>
        </div>
      </div>

      <div class="bg-green-50/30 rounded-xl p-5 border border-green-100">
        <div class="flex items-center mb-4">
          <div class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">2</div>
          <h3 class="text-lg font-semibold text-gray-800 ml-3">Médias</h3>
        </div>

        <!-- IMAGE -->
        <div *ngIf="publicite.media_request === 'image' || publicite.media_request === 'both'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Image (fichier)</label>
            <input type="file" accept="image/*" (change)="onImageSelected($event)">
            <img *ngIf="previewImage" [src]="previewImage" alt="Preview" class="pub-media-large mt-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Image (URL)</label>
            <input pInputText type="text" class="w-full" [(ngModel)]="publicite.image" name="image" placeholder="https://..." [disabled]="!!previewImage">
            <small class="text-gray-500 text-xs">Laissez vide si vous uploadez un fichier</small>
          </div>
        </div>

        <!-- VIDEO -->
        <div *ngIf="publicite.media_request === 'video' || publicite.media_request === 'both'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Vidéo (fichier)</label>
            <input type="file" accept="video/*" (change)="onVideoSelected($event)">
            <video *ngIf="previewVideo" [src]="previewVideo" class="pub-media-large mt-2" controls></video>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Vidéo (URL)</label>
            <input pInputText type="text" class="w-full" [(ngModel)]="publicite.video" name="video" placeholder="https://..." [disabled]="!!previewVideo">
            <small class="text-gray-500 text-xs">Laissez vide si vous uploadez un fichier</small>
          </div>
        </div>
      </div>

      <div class="bg-purple-50/30 rounded-xl p-5 border border-purple-100">
        <div class="flex items-center mb-4">
          <div class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">3</div>
          <h3 class="text-lg font-semibold text-gray-800 ml-3">Description (optionnelle)</h3>
        </div>
        <p-editor [(ngModel)]="publicite.description" name="description" [style]="{height:'260px'}" styleClass="w-full"></p-editor>
      </div>

      <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 flex items-center">
        <i class="pi pi-info-circle mr-2 text-sm"></i>
        Après l’enregistrement, la publicité est en <b>brouillon</b>. La durée et la date seront fixées lors de l’activation.
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="hidden sm:flex items-center space-x-2">
        <div class="w-8 h-1 bg-blue-600 rounded"></div>
        <div class="w-8 h-1 bg-green-600 rounded"></div>
        <div class="w-8 h-1 bg-purple-600 rounded"></div>
      </div>

      <div class="flex gap-2 ml-auto">
        <button pButton label="Annuler" icon="pi pi-times" class="p-button-outlined p-button-sm" (click)="hideDialog()"></button>
        <button pButton label="Enregistrer" icon="pi pi-check" class="p-button-success p-button-sm" (click)="savePublicite()"></button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- ============================= -->
<!-- DIALOG ACTIVATION             -->
<!-- ============================= -->
<p-dialog
  [(visible)]="activationDialog"
  [style]="{width:'720px', maxWidth:'96vw'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="offre-dialog-enhanced">

  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center">
          <div class="bg-white/20 rounded-full p-3 mr-4"><i class="pi pi-play text-2xl"></i></div>
          <div>
            <h2 class="text-xl font-bold">Activer la publicité</h2>
            <p class="text-white/80 text-sm mt-0.5">{{ selectedPubliciteForActivation?.titre }}</p>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="space-y-5" *ngIf="selectedPubliciteForActivation">
      <div class="activation-preview-card">
        <div class="preview-media">
          <img *ngIf="selectedPubliciteForActivation.image || selectedPubliciteForActivation.image_url"
               [src]="selectedPubliciteForActivation.image || selectedPubliciteForActivation.image_url" alt="">
          <video *ngIf="selectedPubliciteForActivation.video || selectedPubliciteForActivation.video_url"
                 [src]="selectedPubliciteForActivation.video || selectedPubliciteForActivation.video_url" controls></video>
          <div *ngIf="!(selectedPubliciteForActivation.image||selectedPubliciteForActivation.image_url||selectedPubliciteForActivation.video||selectedPubliciteForActivation.video_url)"
               class="no-media"><i class="pi pi-image"></i><span>Aucun média</span></div>
        </div>
        <div class="preview-info">
          <h3>{{ selectedPubliciteForActivation.titre }}</h3>
          <div class="preview-meta">
            <span><i class="pi pi-building mr-1"></i>{{ selectedPubliciteForActivation.entreprise?.nom_entreprise }}</span>
            <span><i class="pi pi-tag mr-1"></i>{{ (selectedPubliciteForActivation.media_request || 'image') | titlecase }}</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="config-item full-width">
          <label class="activation-label required"><i class="pi pi-clock mr-2"></i>Durée d'affichage</label>

          <!-- PrimeNG ≥17 : p-select -->
          <p-select
            [options]="pricingTiers"
            [(ngModel)]="activationForm.duree"
            optionLabel="label"
            optionValue="duree"
            placeholder="Sélectionner la durée"
            class="w-full"
            (onChange)="onDurationChange()">
          </p-select>

          <!-- Alternative dropdown si besoin
          <p-dropdown [options]="pricingTiers" [(ngModel)]="activationForm.duree"
                      optionLabel="label" optionValue="duree" placeholder="Sélectionner la durée"
                      styleClass="w-full" (onChange)="onDurationChange()"></p-dropdown>
          -->
        </div>

        <div class="config-item">
          <label class="activation-label required"><i class="pi pi-calendar mr-2"></i>Date de début</label>
          <p-calendar [(ngModel)]="activationForm.date_debut" [showIcon]="true" dateFormat="dd/mm/yy" [minDate]="minDate" styleClass="w-full"></p-calendar>
        </div>

        <div class="config-item" *ngIf="activationForm.prix_calcule > 0">
          <label class="activation-label"><i class="pi pi-wallet mr-2"></i>Prix total</label>
          <div class="price-amount">{{ activationForm.prix_calcule | number }} <span>FCFA</span></div>
        </div>
      </div>

      <div *ngIf="activationForm.prix_calcule > 0" class="payment-methods-grid">
        <div
          *ngFor="let method of paymentMethods"
          class="payment-method-card"
          [class.selected]="activationForm.moyen_paiement === method.value"
          (click)="activationForm.moyen_paiement = method.value; onPaymentMethodChange()">
          <div class="payment-method-radio">
            <p-radioButton [inputId]="method.value" name="payment" [value]="method.value" [(ngModel)]="activationForm.moyen_paiement"></p-radioButton>
          </div>
          <div class="payment-method-icon"><i [class]="method.icon"></i></div>
          <div class="payment-method-info">
            <span class="method-name">{{ method.label }}</span>
            <small class="method-desc">{{ method.description || 'Paiement sécurisé' }}</small>
          </div>
          <i class="pi pi-check-circle payment-check"></i>
        </div>
      </div>

      <div *ngIf="generatedPaymentCode" class="payment-code-section">
        <div class="payment-code-header"><i class="pi pi-qrcode"></i><span>Code de paiement</span></div>
        <div class="payment-code-display">
          <div class="code-value">{{ generatedPaymentCode }}</div>
          <p-button icon="pi pi-copy" [text]="true" [rounded]="true" severity="secondary" (onClick)="copyPaymentCode()" pTooltip="Copier"></p-button>
        </div>
        <div class="payment-code-hint"><i class="pi pi-arrow-right mr-2"></i>Utilisez ce code pour payer</div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between gap-2 w-full">
      <button pButton label="Annuler" icon="pi pi-times" class="p-button-outlined p-button-sm" (click)="hideActivationDialog()"></button>
      <div class="flex gap-2">
        <button pButton label="Saisir le code" icon="pi pi-key" class="p-button-secondary p-button-sm" (click)="openCodeActivationDialog()" [disabled]="!generatedPaymentCode"></button>
        <button pButton label="Générer / Confirmer" icon="pi pi-check" class="p-button-success p-button-sm" (click)="validateActivation()" [disabled]="!activationForm.duree || !activationForm.date_debut || !activationForm.moyen_paiement"></button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- ============================= -->
<!-- DIALOG CODE D’ACTIVATION      -->
<!-- ============================= -->
<p-dialog
  [(visible)]="codeActivationDialog"
  [style]="{width:'580px', maxWidth:'96vw'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="offre-dialog-enhanced">

  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-indigo-600 to-indigo-500 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center">
          <div class="bg-white/20 rounded-full p-3 mr-3"><i class="pi pi-key text-2xl"></i></div>
          <div>
            <h2 class="text-xl font-bold">Saisir le code d'activation</h2>
            <p class="text-white/80 text-sm mt-0.5">Code reçu par SMS après paiement</p>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="space-y-3">
      <p>Entrez le code d'activation :</p>
      <input pInputText type="text" class="w-full" [(ngModel)]="activationCode" placeholder="Ex.: PUB-123456" maxlength="20">
      <small class="text-gray-500">Le code commence par « PUB- » (8–12 caractères).</small>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button pButton label="Annuler" icon="pi pi-times" class="p-button-outlined p-button-sm" (click)="hideCodeActivationDialog()"></button>
      <button pButton label="Activer" icon="pi pi-check" class="p-button-success p-button-sm" (click)="finalizeActivation()" [disabled]="!activationCode || activationCode.length < 6"></button>
    </div>
  </ng-template>
</p-dialog>

<!-- ============================= -->
<!-- DIALOG DÉTAILS                -->
<!-- ============================= -->
<p-dialog
  [(visible)]="detailsDialog"
  [style]="{width:'960px', maxWidth:'98vw'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="offre-dialog-enhanced">

  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-sky-600 to-sky-500 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="bg-white/20 rounded-full p-3 mr-4"><i class="pi pi-eye text-2xl"></i></div>
            <div>
              <h2 class="text-xl font-bold">Détails de la publicité</h2>
              <p class="text-white/80 text-sm mt-0.5">{{ selectedPubliciteForDetails?.titre }}</p>
            </div>
          </div>
          <p-tag
            [value]="selectedPubliciteForDetails?.statut || 'brouillon'"
            [severity]="getStatusColor(selectedPubliciteForDetails?.statut)">
          </p-tag>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="space-y-6" *ngIf="selectedPubliciteForDetails">
      <div class="details-hero">
        <div class="details-media-container">
          <div *ngIf="selectedPubliciteForDetails.image || selectedPubliciteForDetails.image_url" class="details-media">
            <img [src]="selectedPubliciteForDetails.image || selectedPubliciteForDetails.image_url" alt="">
            <div class="media-badge"><i class="pi pi-image mr-1"></i>Image</div>
          </div>
          <div *ngIf="selectedPubliciteForDetails.video || selectedPubliciteForDetails.video_url" class="details-media">
            <video [src]="selectedPubliciteForDetails.video || selectedPubliciteForDetails.video_url" controls></video>
            <div class="media-badge"><i class="pi pi-video mr-1"></i>Vidéo</div>
          </div>
          <div *ngIf="!(selectedPubliciteForDetails.image||selectedPubliciteForDetails.image_url||selectedPubliciteForDetails.video||selectedPubliciteForDetails.video_url)" class="no-media-placeholder">
            <i class="pi pi-image"></i><span>Aucun média disponible</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-xl p-4">
          <h3 class="text-base font-bold text-gray-800 mb-3 flex items-center">
            <i class="pi pi-info-circle text-sky-600 mr-2"></i>Infos principales
          </h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">Entreprise :</span><span class="font-medium">{{ selectedPubliciteForDetails.entreprise?.nom_entreprise || '—' }}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Type média :</span><span class="font-medium">{{ (selectedPubliciteForDetails.media_request || 'image') | titlecase }}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Lien externe :</span>
              <span class="font-medium break-all">
                <a *ngIf="selectedPubliciteForDetails.lien_externe" [href]="selectedPubliciteForDetails.lien_externe" target="_blank" class="text-primary">
                  {{ selectedPubliciteForDetails.lien_externe }} <i class="pi pi-external-link ml-1"></i>
                </a>
                <ng-container *ngIf="!selectedPubliciteForDetails.lien_externe">—</ng-container>
              </span>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-4">
          <h3 class="text-base font-bold text-gray-800 mb-3 flex items-center">
            <i class="pi pi-calendar text-sky-600 mr-2"></i>Dates & prix
          </h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600">Date de début :</span><span class="font-medium">{{ selectedPubliciteForDetails.date_debut | date:'dd/MM/yyyy' }}</span></div>
            <div class="flex justify-between"><span class="text-gray-600">Date de fin :</span><span class="font-medium">{{ selectedPubliciteForDetails.date_fin | date:'dd/MM/yyyy' }}</span></div>
            <div class="flex justify-between" *ngIf="selectedPubliciteForDetails.prix"><span class="text-gray-600">Prix payé :</span><span class="font-medium text-green-700">{{ selectedPubliciteForDetails.prix | number }} FCFA</span></div>
          </div>
        </div>
      </div>

      <div *ngIf="selectedPubliciteForDetails.description" class="bg-gray-50 rounded-xl p-4">
        <h3 class="text-base font-bold text-gray-800 mb-3 flex items-center">
          <i class="pi pi-align-left text-sky-600 mr-2"></i>Description
        </h3>
        <div class="bg-white rounded-lg border border-gray-200 p-4 cd-content-html" [innerHTML]="selectedPubliciteForDetails.description"></div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between gap-2">
      <div class="flex gap-2">
        <p-button *ngIf="selectedPubliciteForDetails && canActivate(selectedPubliciteForDetails)" label="Activer" icon="pi pi-play" severity="success" (onClick)="openActivationDialog(selectedPubliciteForDetails!)"></p-button>
      </div>
      <div class="flex gap-2">
        <p-button label="Modifier" icon="pi pi-pencil" severity="secondary" [outlined]="true" (onClick)="editPublicite(selectedPubliciteForDetails!)"></p-button>
        <p-button label="Fermer" icon="pi pi-times" (onClick)="hideDetailsDialog()"></p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<style>
/* Thumbs & media */
.pub-media-thumb{max-width:140px;max-height:90px;width:auto;height:auto;border-radius:8px;object-fit:cover;display:block}
.pub-media-large{max-width:100%;max-height:260px;width:auto;height:auto;object-fit:contain}

/* Unification dialogs (même logique que composant Offres) */
::ng-deep .offre-dialog-enhanced .p-dialog{border-radius:.875rem!important;overflow:hidden;box-shadow:0 25px 50px -12px rgb(0 0 0 / .25)}
::ng-deep .offre-dialog-enhanced .p-dialog-header{padding:0!important;background:transparent!important;border:none!important}
::ng-deep .offre-dialog-enhanced .p-dialog-content{padding:1.5rem!important;max-height:calc(85vh - 140px);overflow-y:auto;overflow-x:hidden}
::ng-deep .offre-dialog-enhanced .p-dialog-footer{padding:1rem 1.5rem!important;background:linear-gradient(to top,#fafafa,transparent);border-top:1px solid #e5e7eb}

/* Rich text safe */
.cd-content-html{white-space:normal;overflow-wrap:anywhere;word-break:break-word;line-height:1.7}
.cd-content-html img,.cd-content-html video,.cd-content-html iframe{max-width:100%!important;height:auto!important;display:block;border-radius:8px;margin:.5rem 0}
.cd-content-html pre,.cd-content-html code{white-space:pre-wrap;overflow-x:auto;background:#f3f4f6;padding:.25rem .5rem;border-radius:4px;font-family:'Courier New',monospace;font-size:.9em}

/* Activation preview bits (repris du modèle) */
.activation-preview-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:1rem;display:flex;align-items:center;gap:1rem}
.preview-media{flex-shrink:0;width:120px;height:90px;border-radius:12px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.preview-media img,.preview-media video{width:100%;height:100%;object-fit:cover}
.preview-media .no-media{display:flex;flex-direction:column;align-items:center;gap:.5rem;color:#9ca3af;font-size:.85rem}
.preview-info h3{margin:0 0 .5rem;font-size:1.1rem;font-weight:600;color:#111827}
.preview-meta{display:flex;gap:1rem;font-size:.85rem;color:#6b7280}

/* Payment cards */
.payment-methods-grid{display:grid;gap:1rem}
.payment-method-card{display:grid;grid-template-columns:auto auto 1fr auto;gap:1rem;align-items:center;padding:1rem;border:2px solid #e5e7eb;border-radius:12px;cursor:pointer;transition:all .2s;background:#fff}
.payment-method-card:hover{border-color:#d1d5db;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.payment-method-card.selected{border-color:#22c55e;background:#ecfdf5}
.payment-method-icon{width:44px;height:44px;border-radius:12px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:1.25rem;color:#6b7280}
.payment-method-card.selected .payment-method-icon{background:#22c55e;color:#fff}
.payment-check{color:#22c55e;font-size:1.25rem;opacity:0;transition:opacity .2s}
.payment-method-card.selected .payment-check{opacity:1}

/* Price */
.price-amount{font-size:2rem;font-weight:800;color:#047857}
.price-amount span{font-size:1rem;font-weight:600;margin-left:.25rem}

/* Details hero */
.details-hero{margin-bottom:1rem}
.details-media-container{background:#1f2937;border-radius:16px;padding:1.25rem;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,.15)}
.details-media{position:relative}
.details-media img,.details-media video{max-width:100%;max-height:400px;border-radius:12px}
.media-badge{position:absolute;top:1rem;right:1rem;background:rgba(0,0,0,.7);color:#fff;padding:.35rem .75rem;border-radius:8px;font-size:.85rem;font-weight:600}
.no-media-placeholder{display:flex;flex-direction:column;align-items:center;gap:1rem;padding:3rem 1rem;color:#9ca3af}
.no-media-placeholder i{font-size:3rem;opacity:.6}

/* Inputs look & focus */
::ng-deep .p-inputtext,::ng-deep .p-dropdown,::ng-deep .p-select,::ng-deep .p-calendar .p-inputtext{border-radius:.5rem!important;transition:all .2s}
::ng-deep .p-inputtext:focus,::ng-deep .p-dropdown:focus,::ng-deep .p-select:focus,::ng-deep .p-calendar .p-inputtext:focus{border-color:#3b82f6!important;box-shadow:0 0 0 3px rgba(59,130,246,.1)!important}

/* Buttons */
::ng-deep .p-button-sm{padding:.5rem 1rem!important;font-size:.875rem!important;border-radius:.5rem!important;font-weight:500!important}
::ng-deep .p-button{transition:all .2s ease}
::ng-deep .p-button:not(:disabled):hover{transform:translateY(-1px);box-shadow:0 4px 6px -1px rgb(0 0 0 / .1),0 2px 4px -2px rgb(0 0 0 / .1)}

/* Responsive */
@media (max-width:768px){
  .pub-media-large{max-height:200px}
}
</style>
