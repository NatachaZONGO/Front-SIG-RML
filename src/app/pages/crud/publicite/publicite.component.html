<!-- publicite.component.html -->
<p-toast />
<p-confirmDialog />

<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <p-button label="Nouvelle Publicité" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    <p-button severity="secondary" label="Supprimer" icon="pi pi-trash" outlined
              (onClick)="deleteSelectedPublicites()"
              [disabled]="!selectedPublicites || !selectedPublicites.length" />
  </ng-template>
  <ng-template #end>
    <p-button label="Export" icon="pi pi-upload" severity="secondary" (click)="exportCSV()" />
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="publicites"
  [rows]="10"
  [columns]="cols"
  [paginator]="true"
  [globalFilterFields]="['titre','entreprise.nom_entreprise','lien_externe','statut']"
  [tableStyle]="{ 'min-width': '75rem' }"
  [(selection)]="selectedPublicites"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]"
>
  <ng-template #caption>
    <div class="flex items-center justify-between">
      <h5 class="m-0">Gestion des Publicités</h5>
      <p-iconField>
        <p-inputIcon styleClass="pi pi-search" />
        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..." />
      </p-iconField>
    </div>
  </ng-template>

  <ng-template #header>
    <tr>
      <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
      <th pSortableColumn="titre" style="min-width:16rem">Titre <p-sortIcon field="titre" /></th>
      <th pSortableColumn="entreprise.nom_entreprise" style="min-width:16rem">Entreprise <p-sortIcon field="entreprise.nom_entreprise" /></th>
      <th style="min-width:18rem">Media</th>
      <th pSortableColumn="lien_externe" style="min-width:16rem">Lien <p-sortIcon field="lien_externe" /></th>
      <th pSortableColumn="statut" style="min-width:12rem">Statut <p-sortIcon field="statut" /></th>
      <th style="min-width: 16rem">Actions</th>
    </tr>
  </ng-template>

  <ng-template #body let-publicite>
    <tr>
      <td style="width: 3rem"><p-tableCheckbox [value]="publicite" /></td>

      <td style="min-width: 16rem">
        <strong>{{ publicite.titre }}</strong>
        <br>
        <small class="text-color-secondary">{{ publicite.media_request | titlecase }}</small>
      </td>

      <td style="min-width: 16rem">{{ publicite.entreprise?.nom_entreprise }}</td>

      <!-- TABLE PREVIEW MEDIA (robuste: URL ou chemin storage) -->
      <td style="min-width: 18rem">
        <img *ngIf="publicite.image || publicite.image_url"
             [src]="publicite.image || publicite.image_url"
             alt="Image"
             style="max-width: 120px; max-height: 80px; margin-right: 8px;">
        <video *ngIf="publicite.video || publicite.video_url"
               [src]="publicite.video || publicite.video_url"
               style="max-width: 160px; max-height: 90px;" controls></video>
      </td>

      <td style="min-width: 16rem">
        <a *ngIf="publicite.lien_externe" [href]="publicite.lien_externe" target="_blank" class="text-primary">
          {{ publicite.lien_externe }}
        </a>
      </td>

      <td style="min-width: 12rem">
        <p-tag [value]="publicite.statut || 'brouillon'" [severity]="getStatusColor(publicite.statut)"></p-tag>
      </td>

      <td style="min-width: 16rem">
        <div class="flex gap-2">
          <!-- Activer -->
          <p-button 
            *ngIf="canActivate(publicite)"
            icon="pi pi-play" 
            label="Activer"
            [outlined]="true" 
            severity="success"
            size="small"
            (click)="openActivationDialog(publicite)"
            pTooltip="Activer cette publicité" />

          <!-- Détails -->
          <p-button 
            icon="pi pi-eye" 
            [rounded]="true" 
            [outlined]="true" 
            severity="info"
            size="small"
            (click)="viewPubliciteDetails(publicite)"
            pTooltip="Voir les détails" />

          <!-- Éditer -->
          <p-button 
            icon="pi pi-pencil" 
            [rounded]="true" 
            [outlined]="true" 
            severity="secondary"
            size="small"
            (click)="editPublicite(publicite)"
            pTooltip="Modifier" />

          <!-- Supprimer -->
          <p-button 
            icon="pi pi-trash"  
            severity="danger" 
            [rounded]="true" 
            [outlined]="true" 
            size="small"
            (click)="deletePublicite(publicite)"
            pTooltip="Supprimer" />
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- DIALOG DE CRÉATION/MODIFICATION DE PUBLICITÉ -->
<p-dialog [(visible)]="publiciteDialog" [style]="{ width: '780px' }" header="{{ publicite.id ? 'Modifier' : 'Créer' }} une publicité" [modal]="true">
  <ng-template #content>
    <div class="flex flex-col gap-6">
      <div>
        <label for="titre" class="block font-bold mb-2">Titre *</label>
        <input type="text" pInputText id="titre" [(ngModel)]="publicite.titre" required [style]="{ 'width': '100%' }" />
        <small class="text-red-500" *ngIf="submitted && !publicite.titre">Le titre est obligatoire.</small>
      </div>

      <!-- CHAMP ENTREPRISE (corrigé) -->
      <div>
        <label class="block font-bold mb-2">Entreprise *</label>
        <p-dropdown 
          [options]="entreprises" 
          [(ngModel)]="publicite.entreprise_id" 
          optionLabel="nom_entreprise" 
          optionValue="id"
          placeholder="Sélectionner une entreprise"
          [style]="{ 'width': '100%' }">
        </p-dropdown>
        <small class="text-red-500" *ngIf="submitted && !publicite.entreprise_id">
          L'entreprise est obligatoire.
        </small>
      </div>

      <div>
        <label class="block font-bold mb-2">Type de média *</label>
        <p-dropdown [options]="mediaModes" [(ngModel)]="publicite.media_request" (onChange)="onMediaModeChange()"
                    placeholder="Choisir le type de média" [style]="{ 'width': '100%' }"></p-dropdown>
      </div>

      <!-- IMAGE -->
      <div *ngIf="publicite.media_request === 'image' || publicite.media_request === 'both'" class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-bold mb-2">Image (fichier)</label>
          <input type="file" accept="image/*" (change)="onImageSelected($event)" />
          <img *ngIf="previewImage" [src]="previewImage" alt="Preview" style="display:block;max-width:150px;margin-top:10px;">
        </div>
        <div>
          <label class="block font-bold mb-2">Image (URL)</label>
          <input type="text" pInputText [(ngModel)]="publicite.image" placeholder="https://..." [disabled]="!!previewImage" />
          <small class="text-color-secondary">Laissez vide si vous uploadez un fichier.</small>
        </div>
      </div>

      <!-- VIDEO -->
      <div *ngIf="publicite.media_request === 'video' || publicite.media_request === 'both'" class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-bold mb-2">Vidéo (fichier)</label>
          <input type="file" accept="video/*" (change)="onVideoSelected($event)" />
          <video *ngIf="previewVideo" [src]="previewVideo" style="display:block;max-width:200px;margin-top:10px;" controls></video>
        </div>
        <div>
          <label class="block font-bold mb-2">Vidéo (URL)</label>
          <input type="text" pInputText [(ngModel)]="publicite.video" placeholder="https://..." [disabled]="!!previewVideo" />
          <small class="text-color-secondary">Laissez vide si vous uploadez un fichier.</small>
        </div>
      </div>

      <div>
        <label class="block font-bold mb-2">Lien externe</label>
        <input type="url" pInputText [(ngModel)]="publicite.lien_externe" placeholder="https://votre-site.com" />
      </div>

      <!-- Éditeur riche -->
      <div>
        <label class="block font-bold mb-2">Description</label>
        <p-editor [(ngModel)]="publicite.description" [style]="{height:'200px'}"></p-editor>
        <small class="text-color-secondary">La description sera visible dans les détails de la publicité.</small>
      </div>

      <!-- Info : durée/date seront définies à l’activation -->
      <div class="p-4 bg-blue-50 border-left-3 border-blue-500">
        <i class="pi pi-info-circle text-blue-500 mr-2"></i>
        <strong>Information :</strong> Après création, votre publicité sera en mode "brouillon". 
        La <u>durée</u> et la <u>date de début</u> seront définies lors de l’activation (bouton « Activer »).
      </div>
    </div>
  </ng-template>

  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button label="Annuler" icon="pi pi-times" (click)="hideDialog()" [outlined]="true" />
      <p-button label="Enregistrer" icon="pi pi-check" (click)="savePublicite()" />
    </div>
  </ng-template>
</p-dialog>

<!-- DIALOG D'ACTIVATION DE PUBLICITÉ -->
<p-dialog [(visible)]="activationDialog" [style]="{ width: '600px' }" header="Activer la publicité" [modal]="true">
  <ng-template #content>
    <div class="flex flex-col gap-6" *ngIf="selectedPubliciteForActivation">
      
      <!-- Résumé -->
      <div class="p-4 bg-gray-50 border-round">
        <h6 class="mt-0 mb-3">Publicité à activer :</h6>
        <div class="flex gap-4 items-center">
          <img *ngIf="selectedPubliciteForActivation.image || selectedPubliciteForActivation.image_url" 
               [src]="selectedPubliciteForActivation.image || selectedPubliciteForActivation.image_url" 
               alt="Preview" 
               style="max-width: 80px; max-height: 60px; border-radius: 8px;">
          <div>
            <strong>{{ selectedPubliciteForActivation.titre }}</strong>
            <br>
            <small class="text-color-secondary">{{ selectedPubliciteForActivation.media_request | titlecase }}</small>
          </div>
        </div>
      </div>

      <!-- Durée -->
      <div>
        <label class="block font-bold mb-2">Durée d'affichage *</label>
        <p-dropdown 
          [options]="pricingTiers" 
          [(ngModel)]="activationForm.duree"
          optionLabel="label" 
          optionValue="duree"
          placeholder="Choisir la durée"
          (onChange)="onDurationChange()"
          [style]="{ 'width': '100%' }">
        </p-dropdown>
        <small class="text-color-secondary">Plus la durée est longue, plus le tarif est avantageux.</small>
      </div>

      <!-- Date de début -->
      <div>
        <label class="block font-bold mb-2">Date de début *</label>
        <p-calendar 
          [(ngModel)]="activationForm.date_debut" 
          [showIcon]="true" 
          dateFormat="dd/mm/yy" 
          [minDate]="minDate"
          placeholder="Sélectionner la date"
          [style]="{ 'width': '100%' }">
        </p-calendar>
        <small class="text-color-secondary">La publicité sera active à partir de cette date.</small>
      </div>

      <!-- Prix -->
      <div *ngIf="activationForm.prix_calcule > 0" class="p-4 bg-green-50 border-left-3 border-green-500">
        <div class="flex justify-between items-center">
          <span><strong>Prix total :</strong></span>
          <span class="text-2xl font-bold text-green-700">{{ activationForm.prix_calcule | number }} FCFA</span>
        </div>
      </div>

      <!-- Moyen de paiement -->
      <div *ngIf="activationForm.prix_calcule > 0">
        <label class="block font-bold mb-2">Moyen de paiement *</label>
        <div class="grid grid-cols-1 gap-3">
          <div 
            *ngFor="let method of paymentMethods" 
            class="p-3 border border-gray-300 border-round cursor-pointer hover:bg-gray-50 transition-colors"
            [class.border-primary]="activationForm.moyen_paiement === method.value"
            [class.bg-primary-50]="activationForm.moyen_paiement === method.value"
            (click)="activationForm.moyen_paiement = method.value; onPaymentMethodChange()">
            
            <div class="flex items-center gap-3">
              <p-radioButton 
                [inputId]="method.value" 
                name="payment" 
                [value]="method.value" 
                [(ngModel)]="activationForm.moyen_paiement"
                (onClick)="onPaymentMethodChange()" />
              <i [class]="method.icon" class="text-xl"></i>
              <label [for]="method.value" class="cursor-pointer font-semibold">{{ method.label }}</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Code de paiement -->
      <div *ngIf="generatedPaymentCode" class="p-4 bg-orange-50 border-left-3 border-orange-500">
        <h6 class="mt-0 mb-3">Code de paiement :</h6>
        <div class="bg-white p-3 border-round font-mono text-lg text-center border">
          {{ generatedPaymentCode }}
        </div>
        <div class="mt-3 text-center">
          <p-button 
            label="Copier le code" 
            icon="pi pi-copy" 
            severity="secondary" 
            size="small"
            (click)="copyPaymentCode()">
          </p-button>
        </div>
        <small class="block mt-2 text-color-secondary">
          <strong>Instructions :</strong> Composez ce code sur votre téléphone ou rendez-vous dans une agence. 
          Après validation du paiement, vous recevrez un SMS avec le code d'activation de votre publicité.
        </small>
      </div>

      <!-- Étapes -->
      <div *ngIf="generatedPaymentCode" class="p-4 bg-blue-50 border-left-3 border-blue-500">
        <h6 class="mt-0 mb-3"><i class="pi pi-list mr-2"></i>Étapes suivantes :</h6>
        <ol class="list-decimal pl-5 space-y-2">
          <li>Effectuez le paiement avec le code ci-dessus</li>
          <li>Attendez la confirmation par SMS (généralement sous 5 minutes)</li>
          <li>Utilisez le code reçu par SMS pour activer définitivement votre publicité</li>
          <li>Votre publicité sera alors visible sur le site !</li>
        </ol>
      </div>
    </div>
  </ng-template>

  <ng-template #footer>
    <div class="flex justify-between">
      <p-button label="Annuler" icon="pi pi-times" (click)="hideActivationDialog()" [outlined]="true" />
      <p-button 
        label="Confirmer l'activation" 
        icon="pi pi-check" 
        (click)="validateActivation()"
        [disabled]="!generatedPaymentCode" />
    </div>
  </ng-template>
</p-dialog>

<!-- DIALOG DE SAISIE DU CODE D'ACTIVATION -->
<p-dialog [(visible)]="codeActivationDialog" [style]="{ width: '500px' }" header="Saisir le code d'activation" [modal]="true">
  <ng-template #content>
    <div class="flex flex-col gap-4">
      <p class="m-0">
        Saisissez le code d'activation reçu par SMS après votre paiement :
      </p>
      
      <div>
        <label class="block font-bold mb-2">Code d'activation *</label>
        <input 
          type="text" 
          pInputText 
          [(ngModel)]="activationCode" 
          placeholder="Exemple: PUB-123456"
          [style]="{ 'width': '100%' }"
          maxlength="20" />
      </div>

      <small class="text-color-secondary">
        Le code fait généralement 8 à 12 caractères et commence par "PUB-"
      </small>
    </div>
  </ng-template>

  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button label="Annuler" icon="pi pi-times" (click)="hideCodeActivationDialog()" [outlined]="true" />
      <p-button 
        label="Activer" 
        icon="pi pi-check" 
        (click)="finalizeActivation()"
        [disabled]="!activationCode || activationCode.length < 6" />
    </div>
  </ng-template>
</p-dialog>

<!-- DIALOG DES DÉTAILS DE PUBLICITÉ -->
<p-dialog [(visible)]="detailsDialog" [style]="{ width: '800px' }" header="Détails de la publicité" [modal]="true">
  <ng-template #content>
    <div class="flex flex-col gap-6" *ngIf="selectedPubliciteForDetails">
      
      <!-- En-tête -->
      <div class="flex justify-between items-start">
        <div>
          <h4 class="mt-0 mb-2">{{ selectedPubliciteForDetails.titre }}</h4>
          <p-tag 
            [value]="selectedPubliciteForDetails.statut || 'brouillon'" 
            [severity]="getStatusColor(selectedPubliciteForDetails.statut)">
          </p-tag>
        </div>
        <div class="text-right text-color-secondary">
          <small>ID: #{{ selectedPubliciteForDetails.id }}</small>
        </div>
      </div>

      <!-- Infos principales -->
      <div class="grid grid-cols-2 gap-6">
        <div class="flex flex-col gap-4">
          <div>
            <label class="block font-bold text-color-secondary mb-2">Entreprise</label>
            <p class="m-0">{{ selectedPubliciteForDetails.entreprise?.nom_entreprise || 'Non renseignée' }}</p>
          </div>
          <div>
            <label class="block font-bold text-color-secondary mb-2">Type de média</label>
            <p class="m-0">{{ (selectedPubliciteForDetails.media_request | titlecase) || 'Image' }}</p>
          </div>
          <div>
            <label class="block font-bold text-color-secondary mb-2">Lien externe</label>
            <p class="m-0">
              <a *ngIf="selectedPubliciteForDetails.lien_externe" 
                 [href]="selectedPubliciteForDetails.lien_externe" 
                 target="_blank" 
                 class="text-primary">
                {{ selectedPubliciteForDetails.lien_externe }}
                <i class="pi pi-external-link ml-1"></i>
              </a>
              <span *ngIf="!selectedPubliciteForDetails.lien_externe">Non renseigné</span>
            </p>
          </div>
        </div>

        <div class="flex flex-col gap-4">
          <div>
            <label class="block font-bold text-color-secondary mb-2">Date de début</label>
            <p class="m-0">{{ (selectedPubliciteForDetails.date_debut | date:'dd/MM/yyyy') || 'Non définie' }}</p>
          </div>
          <div>
            <label class="block font-bold text-color-secondary mb-2">Date de fin</label>
            <p class="m-0">{{ (selectedPubliciteForDetails.date_fin | date:'dd/MM/yyyy') || 'Non définie' }}</p>
          </div>
          <div *ngIf="selectedPubliciteForDetails.prix">
            <label class="block font-bold text-color-secondary mb-2">Prix payé</label>
            <p class="m-0 font-semibold text-green-600">{{ (selectedPubliciteForDetails.prix | number) || 0 }} FCFA</p>
          </div>
        </div>
      </div>

      <!-- Médias -->
      <div>
        <label class="block font-bold text-color-secondary mb-3">Médias</label>
        <div class="grid grid-cols-2 gap-4">
          <div *ngIf="selectedPubliciteForDetails.image || selectedPubliciteForDetails.image_url" class="text-center">
            <h6 class="mt-0 mb-3">Image</h6>
            <img [src]="selectedPubliciteForDetails.image || selectedPubliciteForDetails.image_url" alt="Image" 
                 style="max-width: 100%; max-height: 200px; border-radius: 8px;">
          </div>
          <div *ngIf="selectedPubliciteForDetails.video || selectedPubliciteForDetails.video_url" class="text-center">
            <h6 class="mt-0 mb-3">Vidéo</h6>
            <video [src]="selectedPubliciteForDetails.video || selectedPubliciteForDetails.video_url" controls 
                   style="max-width: 100%; max-height: 200px; border-radius: 8px;">
            </video>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div *ngIf="selectedPubliciteForDetails.description">
        <label class="block font-bold text-color-secondary mb-3">Description</label>
        <div class="p-4 bg-gray-50 border-round">
          <div [innerHTML]="selectedPubliciteForDetails.description"></div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #footer>
    <div class="flex justify-between">
      <p-button 
        *ngIf="selectedPubliciteForDetails && canActivate(selectedPubliciteForDetails)"
        label="Activer" 
        icon="pi pi-play" 
        severity="success"
        (click)="openActivationDialog(selectedPubliciteForDetails!)" />
      <div class="flex gap-2">
        <p-button 
          label="Modifier" 
          icon="pi pi-pencil" 
          severity="secondary" 
          [outlined]="true"
          (click)="editPublicite(selectedPubliciteForDetails!)" />
        <p-button label="Fermer" icon="pi pi-times" (click)="hideDetailsDialog()" />
      </div>
    </div>
  </ng-template>
</p-dialog>