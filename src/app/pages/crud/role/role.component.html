<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <p-button 
      label="Nouveau rôle" 
      icon="pi pi-plus" 
      severity="success"
      class="mr-2" 
      (onClick)="openNew()" />
    <p-button 
      severity="danger" 
      label="Supprimer" 
      icon="pi pi-trash" 
      [outlined]="true"
      (onClick)="deleteSelectedRoles()"
      [disabled]="!selectedRoles || !selectedRoles.length" />
  </ng-template>

  <ng-template #end>
    <p-button 
      label="Exporter CSV" 
      icon="pi pi-download" 
      severity="help"
      (onClick)="exportCSV()" />
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="roles()"
  [rows]="10"
  [columns]="cols"
  [paginator]="true"
  [globalFilterFields]="['nom', 'description']"
  [tableStyle]="{ 'min-width': '75rem' }"
  [(selection)]="selectedRoles"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} rôles"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]">
  
  <ng-template #caption>
    <div class="flex items-center justify-between">
      <h5 class="m-0 text-xl font-semibold">Gestion des Rôles</h5>
      <p-iconField>
        <p-inputIcon styleClass="pi pi-search" />
        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher un rôle..." />
      </p-iconField>
    </div>
  </ng-template>

  <ng-template #header>
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th pSortableColumn="nom" style="min-width:16rem">
        Nom <p-sortIcon field="nom" />
      </th>
      <th pSortableColumn="description" style="min-width:30rem">
        Description <p-sortIcon field="description" />
      </th>
      <th style="min-width: 12rem">Actions</th>
    </tr>
  </ng-template>

  <ng-template #body let-role>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="role" />
      </td>
      <td style="min-width: 16rem">
        <div class="flex items-center gap-2">
          <i class="pi pi-shield text-blue-600"></i>
          <span class="font-semibold">{{ role.nom }}</span>
        </div>
      </td>
      <td style="min-width: 30rem">
        <span class="text-gray-600">{{ role.description }}</span>
      </td>
      <td>
        <div class="flex gap-2">
          <p-button 
            icon="pi pi-pencil" 
            [rounded]="true" 
            [outlined]="true" 
            severity="secondary"
            size="small"
            (click)="editRole(role)"
            pTooltip="Modifier"
            tooltipPosition="top" />
          <p-button 
            icon="pi pi-trash" 
            severity="danger" 
            [rounded]="true" 
            [outlined]="true"
            size="small"
            (click)="deleteRole(role)"
            pTooltip="Supprimer"
            tooltipPosition="top" />
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template #emptymessage>
    <tr>
      <td colspan="4" class="text-center py-8">
        <div class="flex flex-col items-center gap-2">
          <i class="pi pi-shield text-4xl text-gray-400"></i>
          <p class="text-gray-500">Aucun rôle trouvé</p>
          <p-button 
            label="Créer le premier rôle" 
            icon="pi pi-plus" 
            (onClick)="openNew()" 
            size="small">
          </p-button>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Dialog Créer/Modifier Rôle - MODERNISÉ -->
<p-dialog 
  [(visible)]="roleDialog" 
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  styleClass="role-dialog"
  [style]="{ width: '600px', maxWidth: '90vw' }">
  
  <!-- Header personnalisé -->
  <ng-template #header>
    <div class="dialog-custom-header">
      <div class="header-content">
        <div class="dialog-header-icon">
          <i class="pi pi-shield"></i>
        </div>
        <div class="dialog-header-text">
          <h2 class="text-xl font-bold m-0">
            {{ role.id ? 'Modifier le rôle' : 'Nouveau rôle' }}
          </h2>
          <p class="text-sm m-0 mt-1 opacity-90">
            {{ role.id ? 'Modifiez les informations du rôle' : 'Créez un nouveau rôle dans le système' }}
          </p>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #content>
    <div class="form-container">
      
      <!-- Section Informations -->
      <div class="form-section">
        <div class="section-header">
          <i class="pi pi-info-circle text-blue-600 mr-2"></i>
          <h3 class="section-title">Informations du rôle</h3>
        </div>
        
        <div class="form-grid">
          <!-- Nom du rôle -->
          <div class="form-field full-width">
            <label for="nom" class="field-label">
              Nom du rôle <span class="required">*</span>
            </label>
            <div class="input-with-icon">
              <i class="pi pi-tag input-icon"></i>
              <input 
                type="text" 
                pInputText 
                id="nom" 
                [(ngModel)]="role.nom" 
                placeholder="Ex: Administrateur"
                [class.input-error]="submitted && !role.nom"
                class="field-input pl-10"
                autofocus />
            </div>
            <small class="error-message" *ngIf="submitted && !role.nom">
              Le nom du rôle est obligatoire
            </small>
            <small class="text-gray-500 text-xs mt-1">
              Ce nom sera affiché dans toute l'application
            </small>
          </div>

          <!-- Description -->
          <div class="form-field full-width">
            <label for="description" class="field-label">
              Description <span class="required">*</span>
            </label>
            <div class="textarea-wrapper">
              <textarea 
                pInputTextarea
                id="description" 
                [(ngModel)]="role.description" 
                rows="5"
                placeholder="Décrivez les responsabilités et permissions de ce rôle..."
                [class.input-error]="submitted && !role.description"
                class="field-input">
              </textarea>
            </div>
            <small class="error-message" *ngIf="submitted && !role.description">
              La description est obligatoire
            </small>
            <small class="text-gray-500 text-xs mt-1">
              Expliquez clairement ce que ce rôle permet de faire
            </small>
          </div>
        </div>
      </div>

      <!-- Section Aperçu (optionnel) -->
      <div class="form-section" *ngIf="role.nom || role.description">
        <div class="section-header">
          <i class="pi pi-eye text-blue-600 mr-2"></i>
          <h3 class="section-title">Aperçu</h3>
        </div>
        
        <div class="preview-card">
          <div class="preview-header">
            <div class="preview-icon">
              <i class="pi pi-shield"></i>
            </div>
            <div class="preview-content">
              <h4 class="preview-title">{{ role.nom || 'Nom du rôle' }}</h4>
              <p class="preview-description">{{ role.description || 'Description du rôle' }}</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </ng-template>

  <ng-template #footer>
    <div class="dialog-footer-custom">
      <p-button 
        label="Annuler" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        styleClass="footer-btn-cancel"
        (click)="hideDialog()">
      </p-button>
      <p-button 
        [label]="role.id ? 'Mettre à jour' : 'Créer le rôle'"
        [icon]="role.id ? 'pi pi-check' : 'pi pi-plus'"
        styleClass="footer-btn-submit"
        (click)="saveRole()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<style>
/* ============================================
   STYLES DU TABLEAU
   ============================================ */

::ng-deep .p-datatable .p-datatable-tbody > tr > td {
  vertical-align: middle !important;
}

/* ============================================
   STYLES DU DIALOG RÔLE
   ============================================ */

::ng-deep .role-dialog .p-dialog {
  border-radius: 12px;
  overflow: hidden;
}

::ng-deep .role-dialog .p-dialog-header {
  padding: 0 !important;
  border: 0 !important;
  background: transparent !important;
}

::ng-deep .role-dialog .p-dialog-content {
  padding: 0 !important;
  max-height: 70vh;
  overflow-y: auto;
}

/* Header avec dégradé bleu - FULL WIDTH */
.dialog-custom-header {
  width: 100%;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.5rem 2rem;
}

.dialog-header-icon {
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  flex-shrink: 0;
}

.dialog-header-icon i {
  font-size: 1.75rem;
}

.dialog-header-text {
  flex: 1;
}

/* Container du formulaire */
.form-container {
  padding: 1.5rem 2rem;
  background: #f9fafb;
}

/* Section */
.form-section {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
}

.form-section:last-child {
  margin-bottom: 0;
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 12px;
  border-bottom: 2px solid #f3f4f6;
}

.section-title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #111827;
}

/* Grid de formulaire */
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.25rem;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field.full-width {
  grid-column: 1 / -1;
}

/* Labels */
.field-label {
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

.required {
  color: #ef4444;
}

/* Inputs */
.field-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
}

.field-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.input-error {
  border-color: #ef4444 !important;
}

.error-message {
  color: #ef4444;
  font-size: 13px;
  margin-top: 4px;
}

/* Input avec icône */
.input-with-icon {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 14px;
  z-index: 1;
}

.pl-10 {
  padding-left: 40px !important;
}

/* Textarea */
.textarea-wrapper {
  position: relative;
}

/* Carte d'aperçu */
.preview-card {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid #bfdbfe;
}

.preview-header {
  display: flex;
  gap: 1rem;
  align-items: start;
}

.preview-icon {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border-radius: 12px;
  color: #3b82f6;
  font-size: 1.5rem;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.preview-content {
  flex: 1;
}

.preview-title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 0.5rem;
}

.preview-description {
  margin: 0;
  color: #1e3a8a;
  font-size: 14px;
  line-height: 1.6;
}

/* Footer */
.dialog-footer-custom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  gap: 12px;
  padding: 1rem 2rem;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

::ng-deep .footer-btn-submit {
  background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
  border: none !important;
  padding: 10px 24px !important;
  font-weight: 600 !important;
}

::ng-deep .footer-btn-submit:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
}

::ng-deep .footer-btn-cancel {
  padding: 10px 24px !important;
}

/* Personnalisation PrimeNG */
::ng-deep .role-dialog .p-inputtext {
  border: 1px solid #d1d5db;
  border-radius: 8px;
}

::ng-deep .role-dialog .p-inputtext:enabled:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

::ng-deep .role-dialog .p-inputtextarea {
  border: 1px solid #d1d5db;
  border-radius: 8px;
}

::ng-deep .role-dialog .p-inputtextarea:enabled:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .form-section {
    padding: 1rem;
  }
  
  .header-content {
    padding: 1.25rem 1.5rem;
  }
  
  .dialog-footer-custom {
    flex-direction: column;
  }
  
  .form-container {
    padding: 1rem 1.25rem;
  }
  
  .preview-header {
    flex-direction: column;
  }
}

/* Utilitaires */
.text-gray-400 {
  color: #9ca3af;
}

.text-gray-500 {
  color: #6b7280;
}

.text-gray-600 {
  color: #4b5563;
}

.text-blue-600 {
  color: #2563eb;
}
</style>