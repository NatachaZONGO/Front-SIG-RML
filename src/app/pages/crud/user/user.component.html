<p-toast></p-toast>

<p-toolbar styleClass="mb-6">
  <ng-template pTemplate="start">
    <p-button label="Nouveau" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    <p-button severity="secondary" label="Supprimer" icon="pi pi-trash" outlined
              (onClick)="deleteSelectedUsers()" [disabled]="!selectedUsers || !selectedUsers.length" />
  </ng-template>

  <ng-template pTemplate="end">
    <div class="flex gap-2">
      <p-button 
        label="Export CSV" 
        icon="pi pi-file-excel" 
        severity="secondary" 
        (onClick)="exportCSV()"
        [disabled]="users().length === 0" />
      <p-button 
        label="Export PDF" 
        icon="pi pi-file-pdf" 
        severity="warn" 
        (onClick)="exportPDF()"
        [disabled]="users().length === 0" />
    </div>
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="users()"
  [rows]="10"
  [paginator]="true"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} utilisateurs"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]"
  [globalFilterFields]="['nom','prenom','roleLabel','telephone','email']"
  [(selection)]="selectedUsers"
>
  <!-- CAPTION -->
  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <h5 class="m-0">Gestion des utilisateurs</h5>
      
      <div class="flex items-center gap-4">
        <!-- Filtre par rôle -->
        <div class="flex items-center gap-2">
          <label for="roleFilter" class="text-sm font-medium">Filtrer par rôle:</label>
          <p-dropdown 
            id="roleFilter"
            [(ngModel)]="selectedRoleFilter" 
            [options]="roleFilterOptions" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Tous les rôles"
            [style]="{ 'min-width': '150px' }"
            (onChange)="onRoleFilterChange($event)"
            [showClear]="true">
          </p-dropdown>
        </div>
        
        <!-- Recherche globale -->
        <p-iconField>
          <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
          <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Recherche..." />
        </p-iconField>
      </div>
    </div>
  </ng-template>

  <!-- HEADER -->
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th pSortableColumn="nom" style="min-width:16rem">Nom <p-sortIcon field="nom" /></th>
      <th pSortableColumn="prenom" style="min-width:16rem">Prénom <p-sortIcon field="prenom" /></th>
      <th pSortableColumn="roleLabel" style="min-width:16rem">Rôle <p-sortIcon field="roleLabel" /></th>
      <th pSortableColumn="telephone" style="min-width:16rem">Téléphone <p-sortIcon field="telephone" /></th>
      <th pSortableColumn="email" style="min-width:16rem">Email <p-sortIcon field="email" /></th>
      <th style="min-width:16rem">Photo</th>
      <th pSortableColumn="statut" style="min-width:12rem">Statut <p-sortIcon field="statut" /></th>
      <th style="min-width:12rem">Actions</th>
    </tr>
  </ng-template>

  <!-- BODY -->
  <ng-template pTemplate="body" let-user>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="user" />
      </td>
      <td>{{ user.nom || 'N/A' }}</td>
      <td>{{ user.prenom || 'N/A' }}</td>
      <td>{{ user.roleLabel || 'N/A' }}</td>
      <td>{{ user.telephone || 'N/A' }}</td>
      <td>{{ user.email || 'N/A' }}</td>
      <td>
        <!-- Photo dans le tableau -->
        <ng-container *ngIf="user.photo; else noPhotoTemplate">
          <img [src]="getImageUrl(user.photo)"
               alt="Photo de {{ user.nom }}"
               [ngStyle]="{ width: '50px', height: '50px', 'object-fit': 'cover', 'border-radius': '6px' }"
               (error)="onImageError($event)">
        </ng-container>
        <ng-template #noPhotoTemplate>
          <div class="flex items-center justify-center w-12 h-12 bg-gray-200 rounded"
               style="width: 50px; height: 50px;">
            <i class="pi pi-user text-gray-400"></i>
          </div>
        </ng-template>
      </td>
      <td>
        <p-tag [value]="user.statut" 
               [severity]="user.statut === 'actif' ? 'success' : 'danger'">
        </p-tag>
      </td>
      <td>
        <p-button icon="pi pi-eye" class="mr-2" [rounded]="true" [outlined]="true" 
            severity="secondary" (click)="viewUserDetails(user)" 
            pTooltip="Voir les détails" tooltipPosition="top" />
        <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" 
                  severity="info" (click)="editUser(user)" />
        <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" 
                  (click)="deleteUser(user)" />
      </td>
    </tr>
  </ng-template>

  <!-- MESSAGE VIDE -->
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="9" class="text-center py-6">
        <div class="flex flex-col items-center gap-2">
          <i class="pi pi-users" style="font-size: 2rem; color: #6b7280;"></i>
          <span>Aucun utilisateur trouvé</span>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog [(visible)]="userDialog" [style]="{ width: '600px' }" header="Ajouter / Modifier un utilisateur" [modal]="true">
  <ng-template pTemplate="content">
    <div class="flex flex-col gap-4">
      <div class="flex gap-4">
        <div class="flex-1">
          <label for="nom" class="block font-bold mb-2">Nom</label>
          <input type="text" pInputText id="nom" [(ngModel)]="user.nom" required class="w-full" 
                 [class.ng-invalid]="submitted && !user.nom" />
          <small class="text-red-500" *ngIf="submitted && !user.nom">Le nom est obligatoire.</small>
        </div>
        <div class="flex-1">
          <label for="prenom" class="block font-bold mb-2">Prénom</label>
          <input type="text" pInputText id="prenom" [(ngModel)]="user.prenom" required class="w-full"
                 [class.ng-invalid]="submitted && !user.prenom" />
          <small class="text-red-500" *ngIf="submitted && !user.prenom">Le prénom est obligatoire.</small>
        </div>
      </div>

      <div>
        <label for="role" class="block font-bold mb-2">Rôle</label>
        <p-dropdown id="role" [(ngModel)]="user.roleId" [options]="roles" optionLabel="label" optionValue="value"
                    placeholder="Sélectionnez un rôle" required [style]="{ 'width': '100%' }"
                    [class.ng-invalid]="submitted && !user.roleId"></p-dropdown>
        <small class="text-red-500" *ngIf="submitted && !user.roleId">Le rôle est obligatoire.</small>
      </div>

      <div class="flex gap-4">
        <div class="flex-1">
          <label for="phone" class="block font-bold mb-2">Téléphone</label>
          <input type="text" pInputText id="phone" [(ngModel)]="user.telephone" required class="w-full"
                 [class.ng-invalid]="submitted && !user.telephone" />
          <small class="text-red-500" *ngIf="submitted && !user.telephone">Le téléphone est obligatoire.</small>
        </div>
        <div class="flex-1">
          <label for="email" class="block font-bold mb-2">Email</label>
          <input type="email" pInputText id="email" [(ngModel)]="user.email" required class="w-full"
                 [class.ng-invalid]="submitted && !user.email" />
          <small class="text-red-500" *ngIf="submitted && !user.email">L'email est obligatoire.</small>
        </div>
      </div>

      <div>
        <label for="password" class="block font-bold mb-2">
          Mot de passe {{ user.id ? '(laisser vide pour ne pas changer)' : '' }}
        </label>
        <input type="password" pInputText id="password" [(ngModel)]="user.password" 
               [required]="!user.id" class="w-full"
               [class.ng-invalid]="submitted && !user.password && !user.id" />
        <small class="text-red-500" *ngIf="submitted && !user.password && !user.id">
          Le mot de passe est obligatoire pour la création.
        </small>
      </div>

      <div class="flex gap-4">
        <div class="flex-1">
          <label for="statut" class="block font-bold mb-2">Statut</label>
          <p-dropdown id="statut" [(ngModel)]="user.statut" [options]="statuts" optionLabel="label"
                      optionValue="value" placeholder="Sélectionnez un statut" required [style]="{ 'width': '100%' }"
                      [class.ng-invalid]="submitted && !user.statut"></p-dropdown>
          <small class="text-red-500" *ngIf="submitted && !user.statut">Le statut est obligatoire.</small>
        </div>
        <div class="flex-1">
          <label for="image" class="block font-bold mb-2">Photo</label>
          <input type="file" id="image" (change)="onFileChange($event)"
                 accept="image/jpeg, image/png, image/jpg, image/gif" class="w-full" />
          
          <!-- Aperçu de la nouvelle photo sélectionnée -->
          <div class="flex justify-center mt-3" *ngIf="previewPhotoUrl">
            <div class="relative">
              <img [src]="previewPhotoUrl" alt="Aperçu de la nouvelle photo" 
                   class="w-32 h-32 object-cover rounded border-2 border-blue-300" />
              <span class="absolute top-0 left-0 bg-blue-500 text-white text-xs px-2 py-1 rounded">
                Nouveau
              </span>
            </div>
          </div>
          
          <!-- Photo actuelle (si pas de nouveau fichier) -->
          <div class="flex justify-center mt-3" *ngIf="!previewPhotoUrl && user.photo">
            <div class="relative">
              <img [src]="getImageUrl(user.photo)" alt="Photo actuelle" 
                   class="w-32 h-32 object-cover rounded border-2 border-gray-300"
                   (error)="onImageError($event)" />
              <span class="absolute top-0 left-0 bg-gray-500 text-white text-xs px-2 py-1 rounded">
                Actuelle
              </span>
            </div>
          </div>
          
          <!-- Message si aucune photo -->
          <div class="flex justify-center mt-3" *ngIf="!previewPhotoUrl && !user.photo">
            <div class="w-32 h-32 border-2 border-dashed border-gray-300 rounded flex items-center justify-center">
              <div class="text-center text-gray-500">
                <i class="pi pi-image text-2xl block mb-2"></i>
                <span class="text-sm">Aucune photo</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <p-button label="Annuler" icon="pi pi-times" text (click)="hideDialog()" />
    <p-button label="Enregistrer" icon="pi pi-check" (click)="saveUser()" />
  </ng-template>
</p-dialog>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<!-- Dialog de détails utilisateur -->
<p-dialog
  [(visible)]="userDetailsDialog"
  [style]="{width: '750px', maxWidth: '90vw'}"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="user-details-dialog">

  <!-- En-tête personnalisé -->
  <ng-template pTemplate="header">
    <div class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-xl">
      <div class="px-6 py-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="bg-white/20 rounded-full p-3 mr-4">
              <i class="pi pi-user text-2xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold">Profil utilisateur</h2>
              <p class="text-white/80 text-sm mt-0.5">
                {{ selectedUserForDetails?.prenom }} {{ selectedUserForDetails?.nom }}
              </p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-white/60 text-sm">#{{ selectedUserForDetails?.id }}</span>
            <p-tag 
              [value]="selectedUserForDetails?.statut || 'Inactif'" 
              [severity]="selectedUserForDetails?.statut === 'actif' ? 'success' : 'danger'"
              styleClass="text-sm font-semibold">
            </p-tag>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="space-y-5" *ngIf="selectedUserForDetails">
      
      <!-- Section Photo et Identité -->
      <div class="flex flex-col md:flex-row gap-5">
        <!-- Photo de profil -->
        <div class="flex-shrink-0">
          <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 text-center">
            <div class="relative inline-block">
              <!-- Photo -->
              <ng-container *ngIf="selectedUserForDetails.photo; else noPhotoDetail">
                <img [src]="getImageUrl(selectedUserForDetails.photo)"
                     alt="Photo de {{ selectedUserForDetails.nom }}"
                     class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg"
                     (error)="onImageError($event)">
              </ng-container>
              <ng-template #noPhotoDetail>
                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center border-4 border-white shadow-lg">
                  <i class="pi pi-user text-4xl text-white"></i>
                </div>
              </ng-template>
              
              <!-- Badge de statut -->
              <div class="absolute bottom-0 right-0">
                <div [class]="'w-6 h-6 rounded-full border-3 border-white ' + 
                            (selectedUserForDetails.statut === 'actif' ? 'bg-green-500' : 'bg-red-500')">
                </div>
              </div>
            </div>
            
            <!-- Nom complet sous la photo -->
            <h3 class="mt-4 text-lg font-bold text-gray-800">
              {{ selectedUserForDetails.prenom }} {{ selectedUserForDetails.nom }}
            </h3>
            <p class="text-sm text-gray-600 mt-1">
              <i class="pi pi-id-card mr-1 text-xs"></i>
              {{ selectedUserForDetails.roleLabel || 'Rôle non défini' }}
            </p>
          </div>
        </div>

        <!-- Informations principales -->
        <div class="flex-grow">
          <div class="bg-gray-50 rounded-xl p-5">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
              <i class="pi pi-info-circle text-indigo-600 mr-2"></i>
              Informations personnelles
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Nom -->
              <div class="space-y-1">
                <label class="text-xs text-gray-500 uppercase tracking-wider">Nom</label>
                <p class="font-semibold text-gray-800 flex items-center">
                  <i class="pi pi-user mr-2 text-gray-400 text-sm"></i>
                  {{ selectedUserForDetails.nom || 'Non renseigné' }}
                </p>
              </div>

              <!-- Prénom -->
              <div class="space-y-1">
                <label class="text-xs text-gray-500 uppercase tracking-wider">Prénom</label>
                <p class="font-semibold text-gray-800 flex items-center">
                  <i class="pi pi-user mr-2 text-gray-400 text-sm"></i>
                  {{ selectedUserForDetails.prenom || 'Non renseigné' }}
                </p>
              </div>

              <!-- Email -->
              <div class="space-y-1">
                <label class="text-xs text-gray-500 uppercase tracking-wider">Email</label>
                <p class="font-semibold text-gray-800 flex items-center">
                  <i class="pi pi-envelope mr-2 text-gray-400 text-sm"></i>
                  <a [href]="'mailto:' + selectedUserForDetails.email" 
                     class="text-indigo-600 hover:underline">
                    {{ selectedUserForDetails.email || 'Non renseigné' }}
                  </a>
                </p>
              </div>

              <!-- Téléphone -->
              <div class="space-y-1">
                <label class="text-xs text-gray-500 uppercase tracking-wider">Téléphone</label>
                <p class="font-semibold text-gray-800 flex items-center">
                  <i class="pi pi-phone mr-2 text-gray-400 text-sm"></i>
                  <a [href]="'tel:' + selectedUserForDetails.telephone" 
                     class="text-indigo-600 hover:underline">
                    {{ selectedUserForDetails.telephone || 'Non renseigné' }}
                  </a>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Rôle et Permissions -->
      <div class="bg-purple-50 rounded-xl p-5">
        <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-shield text-purple-600 mr-2"></i>
          Rôle et permissions
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Rôle actuel</span>
              <i class="pi pi-crown text-purple-600"></i>
            </div>
            <p class="font-bold text-lg text-gray-800">{{ selectedUserForDetails.roleLabel || 'Non défini' }}</p>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Statut du compte</span>
              <i class="pi pi-check-circle text-green-600" *ngIf="selectedUserForDetails.statut === 'actif'"></i>
              <i class="pi pi-times-circle text-red-600" *ngIf="selectedUserForDetails.statut !== 'actif'"></i>
            </div>
            <p class="font-bold text-lg text-gray-800">
              {{ selectedUserForDetails.statut === 'actif' ? 'Actif' : 'Inactif' }}
            </p>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">ID Utilisateur</span>
              <i class="pi pi-hashtag text-purple-600"></i>
            </div>
            <p class="font-bold text-lg text-gray-800">{{ selectedUserForDetails.id }}</p>
          </div>
        </div>
      </div>

      <!-- Section Dates et activité -->
      <div class="bg-blue-50 rounded-xl p-5">
        <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-calendar text-blue-600 mr-2"></i>
          Activité et historique
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-blue-100">
              <span class="text-sm text-gray-600">
                <i class="pi pi-calendar-plus mr-1 text-xs"></i>
                Date de création
              </span>
              <span class="font-medium text-gray-800">
                {{ selectedUserForDetails.created_at ? (selectedUserForDetails.created_at | date:'dd/MM/yyyy') : 'Non disponible' }}
              </span>
            </div>
            
            <div class="flex justify-between items-center py-2 border-b border-blue-100">
              <span class="text-sm text-gray-600">
                <i class="pi pi-clock mr-1 text-xs"></i>
                Heure de création
              </span>
              <span class="font-medium text-gray-800">
                {{ selectedUserForDetails.created_at ? (selectedUserForDetails.created_at | date:'HH:mm') : 'Non disponible' }}
              </span>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-blue-100">
              <span class="text-sm text-gray-600">
                <i class="pi pi-refresh mr-1 text-xs"></i>
                Dernière mise à jour
              </span>
              <span class="font-medium text-gray-800">
                {{ selectedUserForDetails.updated_at ? (selectedUserForDetails.updated_at | date:'dd/MM/yyyy') : 'Jamais' }}
              </span>
            </div>
            
            <div class="flex justify-between items-center py-2 border-b border-blue-100">
              <span class="text-sm text-gray-600">
                <i class="pi pi-sign-in mr-1 text-xs"></i>
                Dernière connexion
              </span>
              <span class="font-medium text-gray-800">
                {{ selectedUserForDetails.last_login ? (selectedUserForDetails.last_login | date:'dd/MM/yyyy HH:mm') : 'Jamais' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="bg-yellow-50 rounded-xl p-5">
        <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
          <i class="pi pi-bolt text-yellow-600 mr-2"></i>
          Actions rapides
        </h3>
        
        <div class="flex flex-wrap gap-3">
          <button pButton
                  label="Envoyer un email"
                  icon="pi pi-envelope"
                  class="p-button-sm p-button-outlined"
                  [disabled]="!selectedUserForDetails.email"
                  (click)="sendEmail(selectedUserForDetails)">
          </button>
          
          <button pButton
                  label="Appeler"
                  icon="pi pi-phone"
                  class="p-button-sm p-button-outlined"
                  [disabled]="!selectedUserForDetails.telephone"
                  (click)="callUser(selectedUserForDetails)">
          </button>
          
          <button pButton
                  [label]="selectedUserForDetails.statut === 'actif' ? 'Désactiver' : 'Activer'"
                  [icon]="selectedUserForDetails.statut === 'actif' ? 'pi pi-lock' : 'pi pi-unlock'"
                  [class]="'p-button-sm p-button-' + (selectedUserForDetails.statut === 'actif' ? 'warning' : 'success')"
                  (click)="toggleUserStatus(selectedUserForDetails)">
          </button>
          
          <button pButton
                  label="Réinitialiser le mot de passe"
                  icon="pi pi-key"
                  class="p-button-sm p-button-info"
                  (click)="resetPassword(selectedUserForDetails)">
          </button>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center w-full">
      <div class="flex gap-2">
        <button pButton
                label="Modifier"
                icon="pi pi-pencil"
                class="p-button-sm p-button-outlined"
                (click)="editFromDetails()">
        </button>
        
        <button pButton
                label="Supprimer"
                icon="pi pi-trash"
                class="p-button-sm p-button-danger p-button-outlined"
                (click)="deleteFromDetails()">
        </button>
      </div>
      
      <button pButton
              label="Fermer"
              icon="pi pi-times"
              class="p-button-sm p-button-secondary"
              (click)="hideDetailsDialog()">
      </button>
    </div>
  </ng-template>
</p-dialog>

<style>
  /* Dialog de détails utilisateur */
::ng-deep .user-details-dialog .p-dialog {
  border-radius: 0.875rem !important;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

::ng-deep .user-details-dialog .p-dialog-header {
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
}

::ng-deep .user-details-dialog .p-dialog-content {
  padding: 1.5rem !important;
  max-height: calc(85vh - 140px);
  overflow-y: auto;
  overflow-x: hidden;
}

::ng-deep .user-details-dialog .p-dialog-footer {
  padding: 1rem 1.5rem !important;
  background: #fafafa;
  border-top: 1px solid #e5e7eb;
}

/* Scrollbar personnalisée */
::ng-deep .user-details-dialog .p-dialog-content::-webkit-scrollbar {
  width: 6px;
}

::ng-deep .user-details-dialog .p-dialog-content::-webkit-scrollbar-track {
  background: #f3f4f6;
  border-radius: 3px;
}

::ng-deep .user-details-dialog .p-dialog-content::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #6366f1, #a855f7);
  border-radius: 3px;
}

/* Tags et badges */
::ng-deep .user-details-dialog .p-tag {
  padding: 0.25rem 0.75rem !important;
  border-radius: 9999px !important;
  font-size: 0.875rem !important;
}

/* Animations */
::ng-deep .user-details-dialog .rounded-xl {
  transition: all 0.3s ease;
}

::ng-deep .user-details-dialog .rounded-xl:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

/* Responsive */
@media (max-width: 640px) {
  ::ng-deep .user-details-dialog .p-dialog {
    margin: 0.5rem !important;
    width: calc(100% - 1rem) !important;
  }
}
</style>